<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…· - æä¾›ç­”é¢˜å¡ç”Ÿæˆã€ç•ªèŒ„æ—¶é’Ÿã€è¯¾è¡¨ç®¡ç†ã€å‡½æ•°ç»˜åˆ¶ç­‰ä¸“ä¸šåŠŸèƒ½">
    <meta name="keywords" content="æ•°å­¦æ•™å­¦,ç­”é¢˜å¡ç”Ÿæˆ,ç•ªèŒ„æ—¶é’Ÿ,è¯¾è¡¨,å‡½æ•°ç»˜åˆ¶,æ•™å¸ˆå·¥å…·">
    <meta name="author" content="ç‹¬ç«‹æ•°å­¦è€å¸ˆ">
    <meta name="theme-color" content="#0071e3">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <title>ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ========== CSSå˜é‡å’Œä¸»é¢˜ç³»ç»Ÿ ========== */
        :root {
            --primary-color: #0071e3;
            --success-color: #34c759;
            --warning-color: #FF9500;
            --error-color: #ff3b30;
            --bg-color: #f5f5f7;
            --text-color: #1d1d1f;
            --text-secondary: #86868b;
            --card-bg: #ffffff;
            --border-color: #e5e5e7;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --primary-color: #2997ff;
            --success-color: #30d158;
            --warning-color: #ffd60a;
            --error-color: #ff453a;
            --bg-color: #000000;
            --text-color: #f5f5f7;
            --text-secondary: #86868b;
            --card-bg: #1c1c1e;
            --border-color: #38383a;
            --gray-200: #374151;
            --gray-700: #e5e7eb;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* ========== å…¨å±€æ ·å¼å’Œä¼˜åŒ– ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Microsoft YaHei", "SimSun", sans-serif;
            background-color: var(--bg-color);
            min-height:  100vh;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* æŒ‰é’®ç„¦ç‚¹çŠ¶æ€ä¼˜åŒ– */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .nav-tabs {
            display: flex;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 16px 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            position: relative;
        }

        .nav-tab:hover {
            background-color: var(--bg-color);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* ç­”é¢˜å¡ç”Ÿæˆç¨‹åºæ ·å¼ */
        .answer-sheet-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .answer-sheet-settings {
            flex: 0 0 350px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 80px;
            height: fit-content;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .answer-sheet-settings h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
        }

        .as-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }

        .as-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .as-section-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .as-form-group {
            margin-bottom: 12px;
        }

        .as-form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }

        .as-form-group input[type="text"],
        .as-form-group input[type="number"],
        .as-form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .as-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .as-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .as-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .as-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .as-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .as-btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .as-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
        }

        .answer-sheet-preview {
            flex: 1;
            min-width: 600px;
        }

        .a4-sheet {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            position: relative;
            box-sizing: border-box;
        }

        @media print {
            .a4-sheet {
                width: 100% !important;
                min-height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
        }

        .answer-sheet {
            font-family: "SimSun", "Microsoft YaHei", sans-serif;
            color: #000;
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }

        .sheet-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: "SimHei", sans-serif;
        }

        .student-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 16px;
            gap: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-underline {
            border-bottom: 1px solid #000;
            min-width: 80px;
            height: 20px;
            display: inline-block;
        }

        .seal-area {
            position: absolute;
            top: 20mm;
            right: 20mm;
            width: 80px;
            height: 80px;
            border: 1px dashed #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
        }

        .notice-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #000;
        }

        .notice-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .notice-content {
            font-size: 12px;
            line-height: 1.6;
        }

        .section-block {
            margin-bottom: 25px;
        }

        .section-title-main {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #000;
        }

        .mcq-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .mcq-item {
            border: 1px solid #000;
            padding: 8px 5px;
            text-align: center;
        }

        .mcq-num {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .mcq-options {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
        }

        .mcq-option {
            width: 14px;
            height: 14px;
            border: 1px solid #000;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: default;
        }

        .blank-section {
            margin-bottom: 20px;
        }

        .blank-item {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .blank-num {
            font-weight: bold;
            margin-right: 10px;
            min-width: 30px;
        }

        .blank-line {
            flex: 1;
            border-bottom: 1px solid #000;
            min-height: 25px;
        }

        .problem-section {
            margin-bottom: 30px;
        }

        .problem-item {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .problem-num {
            font-weight: bold;
            font-size: 16px;
        }

        .problem-score {
            font-size: 14px;
            color: #333;
        }

        .problem-answer-area {
            border: 1px solid #000;
            min-height: 180px;
            position: relative;
        }

        .problem-answer-area::after {
            content: "è§£ç­”åŒºåŸŸ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 14px;
        }

        .problem-score-box {
            position: absolute;
            bottom: 5px;
            right: 5px;
            border: 1px solid #000;
            padding: 2px 8px;
            font-size: 12px;
        }

        /* æ‰“è‰çº¸æ ·å¼ */
        .scratch-paper-container {
            background-color: #ffffff;
            width: 100%;
        }

        .scratch-paper-header {
            text-align: center;
            padding: 15px 0;
            border-bottom: 2px solid #000;
            margin-bottom: 20px;
        }

        .scratch-paper-title {
            font-size: 24px;
            font-weight: bold;
            font-family: "SimHei", sans-serif;
        }

        .scratch-paper-modules {
            display: grid;
            gap: 0;
            width: 100%;
        }

        .scratch-paper-module {
            border: 1px dashed #999;
            min-height: 150px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .scratch-paper-module-label {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-bottom: 5px;
            font-family: "SimSun", sans-serif;
            flex-shrink: 0;
        }

        /* ç•ªèŒ„æ—¶é’Ÿæ ·å¼ */
        .tomato-container {
            max-width: 450px;
            margin: 40px auto;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 40px;
            text-align: center;
        }

        .tomato-current-time {
            font-size: 18px;
            color: #86868b;
            margin-bottom: 20px;
        }

        .tomato-timer-display {
            font-size: 72px;
            font-weight: 300;
            margin: 30px 0;
            color: #1d1d1f;
            letter-spacing: -2px;
        }

        .tomato-mode-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tomato-mode-btn {
            background-color: #f5f5f7;
            border: none;
            border-radius: 18px;
            padding: 8px 16px;
            font-size: 14px;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tomato-mode-btn.active {
            background-color: #0071e3;
            color: white;
        }

        .tomato-mode-btn:hover:not(.active) {
            background-color: #e8e8ed;
        }

        .tomato-control-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
        }

        .tomato-control-btn {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tomato-control-btn.reset {
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .tomato-control-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .tomato-control-btn:active {
            transform: translateY(0);
        }

        .tomato-stats {
            font-size: 14px;
            color: #86868b;
        }

        /* è¯¾è¡¨ç¨‹åºæ ·å¼ */
        .schedule-container-main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .schedule-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .schedule-header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .schedule-date-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .schedule-date-controls button {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .schedule-date-controls button:hover {
            opacity: 0.9;
        }

        .schedule-date-display {
            font-size: 18px;
            font-weight: 500;
        }

        .schedule-controls-bar {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .schedule-btn {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .schedule-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .schedule-btn:active {
            transform: translateY(0);
        }

        .schedule-btn-secondary {
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .schedule-btn-success {
            background-color: #34c759;
        }

        .schedule-table-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            page-break-inside: avoid;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #e5e5e7;
            padding: 12px;
            text-align: center;
            min-width: 120px;
            page-break-inside: avoid;
        }

        .schedule-table th {
            background-color: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
        }

        .schedule-table td {
            height: 80px;
            vertical-align: top;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .schedule-table td:hover {
            background-color: #fafafa;
        }

        .schedule-time-column {
            width: 140px;
            min-width: 140px;
            background-color: #f5f5f7;
            font-weight: 500;
        }

        .schedule-time-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        .schedule-time-input:focus {
            outline: none;
            border-color: #0071e3;
        }

        .schedule-date-subtitle {
            font-size: 12px;
            color: #86868b;
            font-weight: normal;
            margin-top: 4px;
        }

        .schedule-course-card {
            background-color: #007aff;
            color: white;
            border-radius: 8px;
            padding: 8px;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .schedule-course-card:hover {
            transform: scale(1.02);
        }

        .schedule-course-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .schedule-course-location {
            font-size: 11px;
            opacity: 0.9;
        }

        .schedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .schedule-modal.show {
            display: flex;
        }

        .schedule-modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            padding: 30px;
            width: 90%;
            max-width: 400px;
        }

        .schedule-modal-content h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .schedule-form-group {
            margin-bottom: 15px;
        }

        .schedule-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .schedule-form-group input,
        .schedule-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .schedule-form-group input:focus,
        .schedule-form-group select:focus {
            outline: none;
            border-color: #0071e3;
        }

        .schedule-color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .schedule-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .schedule-color-option.selected {
            border-color: #1d1d1f;
        }

        .schedule-color-option:hover {
            transform: scale(1.1);
        }

        .schedule-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .schedule-modal-buttons .schedule-btn {
            flex: 1;
        }

        .schedule-btn-danger {
            background-color: #ff3b30;
        }

        /* å‡½æ•°ç»˜åˆ¶æ ·å¼ */
        .tab-active {
            border-bottom: 2px solid #0071E3;
            color: #0071E3;
            font-medium;
        }

        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .input-apple {
            border-radius: 8px;
            border: 1px solid #d2d2d7;
            background: white;
            padding: 8px 12px;
            transition: all 0.2s ease;
        }

        .input-apple:focus {
            outline: none;
            border-color: #0071E3;
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.2);
        }

        .btn-apple {
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-apple:hover {
            opacity: 0.9;
        }

        .btn-hover:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* é¢œè‰²ç±»å®šä¹‰ */
        .bg-primary {
            background-color: #0071E3;
        }

        .bg-gray-200 {
            background-color: #e5e7eb;
        }

        .bg-warning {
            background-color: #FF9500;
        }

        .text-white {
            color: white;
        }

        .text-gray-700 {
            color: #374151;
        }

        .coord-tooltip {
            position: fixed;
            background: rgba(29, 29, 31, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            pointer-events: none;
        }

        .func-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .func-delete {
            color: #ff3b30;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .func-delete:hover {
            color: #ff2d55;
        }

        .chart-height {
            height: clamp(350px, 65vh, 600px);
        }

        .force-horizontal {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
        }

        .left-panel {
            flex: 0 0 450px;
            min-width: 450px;
            max-width: 450px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .right-panel {
            flex: 1;
            min-width: 500px;
        }

        @media (max-width: 1200px) {
            .left-panel {
                flex: 0 0 400px;
                min-width: 400px;
                max-width: 400px;
            }
            .right-panel {
                min-width: 450px;
            }
        }

        @media (max-width: 992px) {
            .force-horizontal {
                flex-wrap: wrap !important;
            }
            .left-panel {
                flex: 0 0 100%;
                min-width: 100%;
                max-width: 100%;
                max-height: 500px;
                margin-bottom: 1rem;
            }
            .right-panel {
                flex: 0 0 100%;
                min-width: 100%;
            }
        }

        @media print {
            .nav-tabs,
            .answer-sheet-settings,
            .no-print {
                display: none;
            }
            .answer-sheet-preview {
                flex: 1;
                width: 100%;
            }
            .a4-sheet {
                box-shadow: none;
                width: 100%;
                min-height: auto;
                padding: 15mm;
                margin: 0;
            }
            .schedule-table-container {
                box-shadow: none;
                padding: 0;
                margin: 0;
            }
            .schedule-table {
                page-break-inside: auto;
            }
            .schedule-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .schedule-table th,
            .schedule-table td {
                padding: 8px;
            }
        }

        @media (max-width: 768px) {
            .tomato-timer-display {
                font-size: 60px;
            }
            .tomato-container {
                padding: 30px 20px;
            }
            .schedule-table th,
            .schedule-table td {
                min-width: 80px;
                padding: 8px;
                font-size: 12px;
            }
            .schedule-course-card {
                font-size: 10px;
                padding: 6px;
            }
            .schedule-time-column {
                width: 100px;
                min-width: 100px;
            }
            .answer-sheet-settings {
                flex: 1 1 100%;
                position: relative;
                top: 0;
                max-height: none;
            }
            .answer-sheet-preview {
                min-width: 100%;
            }
            .a4-sheet {
                width: 100%;
                transform-origin: top left;
            }
            .month-plan-layout {
                flex-direction: column !important;
            }
            .month-plan-detail-panel {
                width: 100% !important;
            }
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 999;
            font-size: 20px;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
        }

        .theme-toggle-btn:active {
            transform: scale(0.95);
        }

        /* è¯¾è¡¨ç¨‹åºé€‰é¡¹å¡æ ·å¼ */
        .schedule-view-tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .schedule-view-tab:hover {
            background: var(--bg-color);
        }

        .schedule-view-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* å‡ ä½•ç»˜å›¾æ ·å¼ */
        .geometry-tool-btn {
            transition: all 0.2s ease;
        }
        
        .geometry-tool-btn:hover {
            transform: translateY(-2px);
        }
        
        .geometry-tool-btn.active {
            background: rgba(0, 113, 227, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .geometry-color-btn,
        .geometry-fill-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .geometry-color-btn:hover,
        .geometry-fill-btn:hover {
            transform: scale(1.1);
        }
        
        .geometry-color-btn.active,
        .geometry-fill-btn.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        #geometry-canvas {
            background-image: 
                linear-gradient(rgba(200, 200, 200, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 200, 200, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        #geometry-canvas.grid-hidden {
            background-image: none;
        }

        /* æ”¶å…¥è®°å½•æ ·å¼ */
        .income-stats-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 16px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        @media (max-width: 768px) {
            .income-stats-card {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .income-stat-item {
            text-align: center;
            padding: 10px;
        }

        .income-stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .income-stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .income-total-highlight {
            font-size: 24px;
        }

        .income-calendar-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .income-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .income-weekday {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            padding: 8px;
        }

        .income-weekend {
            color: #ef4444;
        }

        .income-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .income-day-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #f8fafc;
            border: 2px solid transparent;
            min-height: 80px;
        }

        .income-day-cell:hover {
            background: #e0f2fe;
            border-color: #38bdf8;
            transform: translateY(-2px);
        }

        .income-day-cell.other-month {
            opacity: 0.4;
            background: #f1f5f9;
        }

        .income-day-cell.today {
            border-color: #10b981;
            background: #d1fae5;
        }

        .income-day-cell.has-data {
            background: #dbeafe;
        }

        .income-day-number {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .income-day-cell.weekend .income-day-number {
            color: #ef4444;
        }

        .income-day-hours {
            font-size: 11px;
            color: #3b82f6;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-bottom: 2px;
        }

        .income-day-amount {
            font-size: 11px;
            color: #ec4899;
            font-weight: 600;
            background: rgba(236, 72, 153, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .income-day-rest {
            font-size: 12px;
            color: #9ca3af;
            margin-top: auto;
        }

        /* æ”¶å…¥è®°å½•æ¨¡æ€æ¡† */
        .income-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .income-modal.show {
            display: flex;
        }

        .income-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .income-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .income-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .income-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
        }

        .income-modal-close:hover {
            color: #374151;
        }

        .income-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .income-form-group {
            margin-bottom: 16px;
        }

        .income-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .income-form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .income-form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .income-form-group input[readonly] {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .income-form-summary {
            background: #f0fdf4;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .income-form-summary-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
        }

        .income-form-total {
            font-size: 16px;
            font-weight: 700;
            color: #059669;
            border-top: 1px dashed #86efac;
            padding-top: 8px;
            margin-top: 8px;
        }

        .income-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .income-modal-actions {
            display: flex;
            gap: 12px;
        }

        .income-btn-cancel {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 15px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-btn-cancel:hover {
            background: #f3f4f6;
        }

        .income-btn-save {
            padding: 10px 24px;
            background: #10b981;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-btn-save:hover {
            background: #059669;
        }

        .income-btn-delete {
            padding: 10px 16px;
            background: #ef4444;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-btn-delete:hover {
            background: #dc2626;
        }

        /* æœˆè®¡åˆ’æ ·å¼ */
        .month-calendar-container {
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin: 0 20px;
        }

        .month-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 12px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-color);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            background: rgba(0, 113, 227, 0.1);
        }
        
        [data-theme="dark"] .calendar-day.today {
            background: rgba(41, 151, 255, 0.2);
        }

        .calendar-day.selected {
            border-color: var(--primary-color);
            background: rgba(0, 113, 227, 0.15);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        [data-theme="dark"] .calendar-day.selected {
            background: rgba(41, 151, 255, 0.25);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .calendar-day.today .calendar-day-number {
            color: var(--primary-color);
        }

        .calendar-dots {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .calendar-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* æœˆè®¡åˆ’è¯¦æƒ…æ¨¡æ€æ¡† - å¤ç”¨ç°æœ‰æ ·å¼ */
    </style>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="åˆ‡æ¢ä¸»é¢˜" title="Ctrl+Dåˆ‡æ¢ä¸»é¢˜">
        ğŸŒ™
    </button>
    <div class="nav-tabs" role="navigation" aria-label="ä¸»å¯¼èˆª">
        <button class="nav-tab active" data-tab="home" role="tab" aria-selected="true">ğŸ  ä¸»é¡µ</button>
        <button class="nav-tab" data-tab="answer-sheet" role="tab" aria-selected="false">ğŸ“ ç­”é¢˜å¡ç”Ÿæˆ</button>
        <button class="nav-tab" data-tab="tomato" role="tab" aria-selected="false">ğŸ… ç•ªèŒ„æ—¶é’Ÿ</button>
        <button class="nav-tab" data-tab="schedule" role="tab" aria-selected="false">ğŸ“… è¯¾è¡¨ç¨‹åº</button>
        <button class="nav-tab" data-tab="function" role="tab" aria-selected="false">ğŸ“Š å‡½æ•°ç»˜åˆ¶</button>
        <button class="nav-tab" data-tab="geometry" role="tab" aria-selected="false">ğŸ“ å‡ ä½•ç»˜å›¾</button>
        <button class="nav-tab" data-tab="income" role="tab" aria-selected="false">ğŸ’° æ”¶å…¥è®°å½•</button>
    </div>

    <!-- ä¸»é¡µ -->
    <div class="tab-content active" id="home">
        <!-- è‹¹æœé£æ ¼çš„heroåŒºåŸŸ -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 py-20 md:py-32">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-semibold text-gray-900 mb-6">
                    ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…·
                </h1>
                <p class="text-xl md:text-2xl text-gray-600 mb-10 max-w-3xl mx-auto">
                    ä¸ºæ•°å­¦æ•™å¸ˆæ‰“é€ çš„ä¸“ä¸šè¾…åŠ©å·¥å…·é›†ï¼Œæé«˜æ•™å­¦æ•ˆç‡ï¼Œä¼˜åŒ–æ•™å­¦ä½“éªŒ
                </p>
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="switchTab('answer-sheet')" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-medium hover:bg-blue-700 transition-colors duration-300 transform hover:-translate-y-1 shadow-lg">
                        ğŸ“ å¼€å§‹ä½¿ç”¨
                    </button>
                    <button onclick="scrollToFeatures()" class="bg-white text-gray-900 px-8 py-3 rounded-full text-lg font-medium hover:bg-gray-100 transition-colors duration-300 transform hover:-translate-y-1 shadow-md border border-gray-200">
                        äº†è§£åŠŸèƒ½
                    </button>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½ç‰¹ç‚¹åŒºåŸŸ -->
        <div id="features" class="py-20 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-semibold text-center text-gray-900 mb-16">
                    ä¸“ä¸šå·¥å…·ï¼Œè½»æ¾æ•™å­¦
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- ç­”é¢˜å¡ç”Ÿæˆ -->
                    <div class="bg-gray-50 rounded-2xl p-8 text-center hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-2">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-file-text-o text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">ç­”é¢˜å¡ç”Ÿæˆ</h3>
                        <p class="text-gray-600 mb-6">å¿«é€Ÿç”Ÿæˆæ ‡å‡†åŒ–ç­”é¢˜å¡ï¼Œæ”¯æŒè‡ªå®šä¹‰é¢˜ç›®æ•°é‡å’Œåˆ†å€¼</p>
                        <button onclick="switchTab('answer-sheet')" class="text-blue-600 font-medium hover:text-blue-800 transition-colors duration-300">
                            å¼€å§‹ä½¿ç”¨ <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>

                    <!-- ç•ªèŒ„æ—¶é’Ÿ -->
                    <div class="bg-gray-50 rounded-2xl p-8 text-center hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-2">
                        <div class="bg-red-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-clock-o text-2xl text-red-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">ç•ªèŒ„æ—¶é’Ÿ</h3>
                        <p class="text-gray-600 mb-6">ç§‘å­¦çš„æ—¶é—´ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©å­¦ç”Ÿä¸“æ³¨å­¦ä¹ ï¼Œæé«˜æ•ˆç‡</p>
                        <button onclick="switchTab('tomato')" class="text-blue-600 font-medium hover:text-blue-800 transition-colors duration-300">
                            å¼€å§‹ä½¿ç”¨ <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>

                    <!-- è¯¾è¡¨ç¨‹åº -->
                    <div class="bg-gray-50 rounded-2xl p-8 text-center hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-2">
                        <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-calendar text-2xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">è¯¾è¡¨ç¨‹åº</h3>
                        <p class="text-gray-600 mb-6">å¯è§†åŒ–è¯¾ç¨‹å®‰æ’ï¼Œæ”¯æŒå¯¼å‡ºPDFå’ŒExcelæ ¼å¼</p>
                        <button onclick="switchTab('schedule')" class="text-blue-600 font-medium hover:text-blue-800 transition-colors duration-300">
                            å¼€å§‹ä½¿ç”¨ <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>

                    <!-- å‡½æ•°ç»˜åˆ¶ -->
                    <div class="bg-gray-50 rounded-2xl p-8 text-center hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-2">
                        <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-line-chart text-2xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">å‡½æ•°ç»˜åˆ¶</h3>
                        <p class="text-gray-600 mb-6">ç›´è§‚ç»˜åˆ¶å„ç§å‡½æ•°å›¾åƒï¼Œæ”¯æŒæ–¹ç¨‹æ±‚è§£å’Œåæ ‡æ˜¾ç¤º</p>
                        <button onclick="switchTab('function')" class="text-blue-600 font-medium hover:text-blue-800 transition-colors duration-300">
                            å¼€å§‹ä½¿ç”¨ <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¼˜åŠ¿åŒºåŸŸ -->
        <div class="bg-gray-50 py-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-semibold text-center text-gray-900 mb-16">
                    ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬çš„å·¥å…·
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-bolt text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">é«˜æ•ˆä¾¿æ·</h3>
                        <p class="text-gray-600">ä¸€é”®ç”Ÿæˆæ‰€éœ€å·¥å…·ï¼Œæ— éœ€å¤æ‚è®¾ç½®ï¼ŒèŠ‚çœæ•™å¸ˆå®è´µæ—¶é—´</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-mobile text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">å“åº”å¼è®¾è®¡</h3>
                        <p class="text-gray-600">é€‚é…å„ç§è®¾å¤‡å±å¹•ï¼Œéšæ—¶éšåœ°ä½¿ç”¨ï¼Œæ•™å­¦æ›´çµæ´»</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-lock text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">å®‰å…¨å¯é </h3>
                        <p class="text-gray-600">æœ¬åœ°è¿è¡Œï¼Œæ•°æ®ä¸ä¸Šä¼ ï¼Œä¿æŠ¤æ•™å¸ˆå’Œå­¦ç”Ÿçš„éšç§ä¿¡æ¯</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨åŒºåŸŸ -->
        <div class="bg-gray-900 text-white py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div>
                        <h3 class="text-2xl font-semibold mb-6">ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…·</h3>
                        <p class="text-gray-400 mb-6">ä¸ºæ•°å­¦æ•™å¸ˆæä¾›ä¸“ä¸šã€é«˜æ•ˆçš„æ•™å­¦è¾…åŠ©å·¥å…·ï¼Œè®©æ•™å­¦æ›´è½»æ¾ï¼Œå­¦ç”Ÿæ›´ä¸“æ³¨ã€‚</p>
                        <div class="flex space-x-4">
                            <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                                <i class="fa fa-github text-xl"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                                <i class="fa fa-envelope text-xl"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                                <i class="fa fa-weixin text-xl"></i>
                            </a>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-6">å¿«é€Ÿè®¿é—®</h3>
                        <ul class="space-y-3">
                            <li><button onclick="switchTab('answer-sheet')" class="text-gray-400 hover:text-white transition-colors duration-300">ç­”é¢˜å¡ç”Ÿæˆ</button></li>
                            <li><button onclick="switchTab('tomato')" class="text-gray-400 hover:text-white transition-colors duration-300">ç•ªèŒ„æ—¶é’Ÿ</button></li>
                            <li><button onclick="switchTab('schedule')" class="text-gray-400 hover:text-white transition-colors duration-300">è¯¾è¡¨ç¨‹åº</button></li>
                            <li><button onclick="switchTab('function')" class="text-gray-400 hover:text-white transition-colors duration-300">å‡½æ•°ç»˜åˆ¶</button></li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-800 mt-12 pt-8 text-center text-gray-500">
                    <p>Â© 2026 ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…·. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­”é¢˜å¡ç”Ÿæˆç¨‹åº -->
    <div class="tab-content" id="answer-sheet">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                è¿”å›ä¸»é¡µ
            </button>
            <div class="text-center mt-2 mb-4">
                <span class="text-sm text-gray-500">å¿«æ·é”®: Ctrl+1(ä¸»é¡µ) Ctrl+2(ç­”é¢˜å¡) Ctrl+3(ç•ªèŒ„é’Ÿ) Ctrl+4(è¯¾è¡¨) Ctrl+5(å‡½æ•°) Esc(è¿”å›ä¸»é¡µ)</span>
            </div>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- æ¨¡å—é€‰é¡¹å¡ -->
            <div class="flex border-b border-gray-200 mb-6" style="background: var(--card-bg); border-radius: 12px; border-bottom: none; padding: 5px; gap: 5px; box-shadow: var(--shadow);">
                <button id="as-tab-answer-sheet" class="schedule-view-tab active py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchAnswerSheetView('answer-sheet')">
                    ğŸ“ ç­”é¢˜å¡ç”Ÿæˆ
                </button>
                <button id="as-tab-scratch-paper" class="schedule-view-tab py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchAnswerSheetView('scratch-paper')">
                    ğŸ“„ æ‰“è‰çº¸
                </button>
            </div>

            <!-- ç­”é¢˜å¡ç”Ÿæˆæ¨¡å— -->
            <section id="as-module-answer-sheet" class="block">
                <div class="force-horizontal gap-6 md:gap-8">
                    <!-- å·¦ä¾§ç­”é¢˜å¡è®¾ç½® -->
                    <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow no-print">
                        <h2>ğŸ“ ç­”é¢˜å¡è®¾ç½®</h2>
                        <div class="as-section">
                            <div class="as-section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                            <div class="as-form-group">
                                <label>è€ƒè¯•åç§°</label>
                                <input type="text" id="examName" value="2025-2026å­¦å¹´ç¬¬äºŒå­¦æœŸæœŸä¸­è€ƒè¯•">
                            </div>
                            <div class="as-form-group">
                                <label>ç§‘ç›®</label>
                                <input type="text" id="subject" value="æ•°å­¦">
                            </div>
                            <div class="as-form-group">
                                <label>è€ƒè¯•æ—¶é—´</label>
                                <input type="text" id="examTime" value="120åˆ†é’Ÿ">
                            </div>
                            <div class="as-form-group">
                                <label>æ»¡åˆ†</label>
                                <input type="number" id="fullScore" value="150" min="0">
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">ğŸ‘¤ å­¦ç”Ÿä¿¡æ¯æ </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showName" checked>
                                <label for="showName" style="margin:0;">å§“å</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showClass" checked>
                                <label for="showClass" style="margin:0;">ç­çº§</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showExamNo" checked>
                                <label for="showExamNo" style="margin:0;">è€ƒå·</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showSeatNo">
                                <label for="showSeatNo" style="margin:0;">åº§ä½å·</label>
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">ğŸ”˜ é€‰æ‹©é¢˜</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="enableMCQ" checked>
                                <label for="enableMCQ" style="margin:0;">å¯ç”¨é€‰æ‹©é¢˜</label>
                            </div>
                            <div class="as-form-group">
                                <label>é¢˜æ•°</label>
                                <input type="number" id="mcqCount" value="12" min="0" max="50">
                            </div>
                            <div class="as-form-group">
                                <label>æ¯é¢˜åˆ†å€¼</label>
                                <input type="number" id="mcqScore" value="5" min="0">
                            </div>
                            <div class="as-form-group">
                                <label>é€‰é¡¹æ•°é‡</label>
                                <select id="mcqOptions">
                                    <option value="4">4ä¸ªé€‰é¡¹ï¼ˆA/B/C/Dï¼‰</option>
                                    <option value="5">5ä¸ªé€‰é¡¹ï¼ˆA/B/C/D/Eï¼‰</option>
                                </select>
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">âœï¸ å¡«ç©ºé¢˜</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="enableBlank" checked>
                                <label for="enableBlank" style="margin:0;">å¯ç”¨å¡«ç©ºé¢˜</label>
                            </div>
                            <div class="as-form-group">
                                <label>é¢˜æ•°</label>
                                <input type="number" id="blankCount" value="6" min="0" max="30">
                            </div>
                            <div class="as-form-group">
                                <label>æ¯é¢˜åˆ†å€¼</label>
                                <input type="number" id="blankScore" value="5" min="0">
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">ğŸ“ è§£ç­”é¢˜</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="enableProblem" checked>
                                <label for="enableProblem" style="margin:0;">å¯ç”¨è§£ç­”é¢˜</label>
                            </div>
                            <div class="as-form-group">
                                <label>é¢˜æ•°</label>
                                <input type="number" id="problemCount" value="6" min="0" max="20">
                            </div>
                            <div class="as-form-group">
                                <label>æ¯é¢˜ç­”é¢˜åŒºåŸŸé«˜åº¦</label>
                                <select id="problemHeight">
                                    <option value="80">è¾ƒå°ï¼ˆ80pxï¼‰</option>
                                    <option value="120" selected>é€‚ä¸­ï¼ˆ120pxï¼‰</option>
                                    <option value="180">è¾ƒå¤§ï¼ˆ180pxï¼‰</option>
                                    <option value="250">è¶…å¤§ï¼ˆ250pxï¼‰</option>
                                </select>
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">âš™ï¸ å…¶ä»–è®¾ç½®</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showNotice" checked>
                                <label for="showNotice" style="margin:0;">æ˜¾ç¤ºæ³¨æ„äº‹é¡¹</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showSealArea">
                                <label for="showSealArea" style="margin:0;">æ˜¾ç¤ºå¯†å°åŒº</label>
                            </div>
                        </div>
                        <div class="as-btn-group">
                            <button class="as-btn as-btn-primary" onclick="printAnswerSheet()">ğŸ–¨ï¸ æ‰“å°</button>
                            <button class="as-btn as-btn-success" onclick="generateAnswerSheet()">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
                        </div>
                        <div class="as-btn-group" style="margin-top: 10px;">
                            <button class="as-btn" style="background: linear-gradient(135deg, #ff9500 0%, #ff3b30 100%); color: white;" onclick="exportAnswerSheetToPDF()">ğŸ“„ å¯¼å‡º PDF</button>
                        </div>
                        <div class="as-btn-group" style="margin-top: 10px;">
                            <button class="as-btn" style="background: linear-gradient(135deg, #5856d6 0%, #af52de 100%); color: white;" onclick="exportAnswerSheetSettings()">ğŸ’¾ å¯¼å‡ºè®¾ç½®</button>
                            <button class="as-btn" style="background: linear-gradient(135deg, #00c7be 0%, #34c759 100%); color: white;" onclick="document.getElementById('importSettingsFile').click()">ğŸ“¥ å¯¼å…¥è®¾ç½®</button>
                            <input type="file" id="importSettingsFile" accept=".json" style="display: none;" onchange="handleImportSettings(event)">
                        </div>
                    </div>
                    <!-- å³ä¾§ç­”é¢˜å¡é¢„è§ˆ -->
                    <div class="right-panel">
                        <div class="a4-sheet" id="answerSheetContainer">
                            <div style="text-align:center; padding:100px 0; color:#999;">
                                ç‚¹å‡»ã€ŒğŸ”„ åˆ·æ–°é¢„è§ˆã€æŒ‰é’®ç”Ÿæˆç­”é¢˜å¡
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ‰“è‰çº¸æ¨¡å— -->
            <section id="as-module-scratch-paper" class="hidden">
                <div class="force-horizontal gap-6 md:gap-8">
                    <!-- å·¦ä¾§æ‰“è‰çº¸è®¾ç½® -->
                    <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow no-print">
                        <h2>ğŸ“„ æ‰“è‰çº¸è®¾ç½®</h2>
                        <div class="as-section">
                            <div class="as-section-title">ğŸ“ åŸºæœ¬è®¾ç½®</div>
                            <div class="as-form-group">
                                <label>æ¨¡å—æ•°é‡ï¼ˆæœ€å¤š20ä¸ªï¼‰</label>
                                <input type="number" id="scratchPaperModules" value="2" min="1" max="20">
                            </div>
                            <div class="as-form-group">
                                <label>æ ‡é¢˜</label>
                                <input type="text" id="scratchPaperTitle" value="æ‰“è‰çº¸">
                            </div>
                        </div>
                        <div class="as-btn-group">
                            <button class="as-btn as-btn-primary" onclick="printScratchPaper()">ğŸ–¨ï¸ æ‰“å°</button>
                            <button class="as-btn as-btn-success" onclick="generateScratchPaper()">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
                        </div>
                        <div class="as-btn-group" style="margin-top: 10px;">
                            <button class="as-btn" style="background: linear-gradient(135deg, #ff9500 0%, #ff3b30 100%); color: white;" onclick="exportScratchPaperToPDF()">ğŸ“„ å¯¼å‡º PDF</button>
                        </div>
                    </div>
                    <!-- å³ä¾§æ‰“è‰çº¸é¢„è§ˆ -->
                    <div class="right-panel">
                        <div class="a4-sheet" id="scratchPaperContainer">
                            <div style="text-align:center; padding:100px 0; color:#999;">
                                ç‚¹å‡»ã€ŒğŸ”„ åˆ·æ–°é¢„è§ˆã€æŒ‰é’®ç”Ÿæˆæ‰“è‰çº¸
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ç•ªèŒ„æ—¶é’Ÿ -->
    <div class="tab-content" id="tomato">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                è¿”å›ä¸»é¡µ
            </button>
        </div>
        <div class="tomato-container">
            <div class="tomato-current-time" id="tomatoCurrentTime"></div>
            <div class="tomato-timer-display" id="tomatoTimerDisplay">25:00</div>
            <div class="tomato-mode-selector">
                <button class="tomato-mode-btn active" data-time="1500">ç•ªèŒ„é’Ÿ (25åˆ†é’Ÿ)</button>
                <button class="tomato-mode-btn" data-time="300">çŸ­ä¼‘æ¯ (5åˆ†é’Ÿ)</button>
                <button class="tomato-mode-btn" data-time="900">é•¿ä¼‘æ¯ (15åˆ†é’Ÿ)</button>
            </div>
            <div class="tomato-control-buttons">
                <button class="tomato-control-btn" id="tomatoStartBtn">å¼€å§‹</button>
                <button class="tomato-control-btn reset" id="tomatoResetBtn">é‡ç½®</button>
            </div>
            <div class="tomato-stats">å·²å®Œæˆç•ªèŒ„é’Ÿ: <span id="tomatoCount">0</span></div>
        </div>
    </div>

    <!-- è¯¾è¡¨ç¨‹åº -->
    <div class="tab-content" id="schedule">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                è¿”å›ä¸»é¡µ
            </button>
        </div>
        <div class="schedule-container-main">
            <div class="schedule-header">
                <h1>ğŸ“… è¯¾è¡¨ç¨‹åº</h1>
            </div>
            
            <!-- è¯¾è¡¨ç¨‹åºé€‰é¡¹å¡ -->
            <div class="flex border-b border-gray-200 mb-6" style="background: var(--card-bg); border-radius: 12px; border-bottom: none; padding: 5px; gap: 5px; box-shadow: var(--shadow); margin: 0 20px 20px;">
                <button id="schedule-tab-week" class="schedule-view-tab active py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchScheduleView('week')">
                    ğŸ“† å‘¨è¯¾è¡¨
                </button>
                <button id="schedule-tab-month" class="schedule-view-tab py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchScheduleView('month')">
                    ğŸ—“ï¸ æœˆè®¡åˆ’
                </button>
            </div>
            
            <!-- å‘¨è¯¾è¡¨æ¨¡å— -->
            <div id="schedule-module-week">
                <div class="schedule-date-controls">
                    <button onclick="changeWeek(-1)">&lt; ä¸Šä¸€å‘¨</button>
                    <span class="schedule-date-display" id="weekDisplay"></span>
                    <button onclick="changeWeek(1)">ä¸‹ä¸€å‘¨ &gt;</button>
                    <button class="schedule-btn-secondary" onclick="goToThisWeek()">æœ¬å‘¨</button>
                </div>
                <div class="schedule-controls-bar">
                    <button class="schedule-btn schedule-btn-success" onclick="addScheduleRow()">â• æ·»åŠ è¡Œ</button>
                    <button class="schedule-btn schedule-btn-danger" onclick="deleteScheduleRow()">ğŸ—‘ï¸ åˆ é™¤è¡Œ</button>
                    <button class="schedule-btn schedule-btn-secondary" onclick="resetSchedule()">ğŸ”„ é‡ç½®</button>
                    <button class="schedule-btn" onclick="exportToPDF()">å¯¼å‡º PDF</button>
                    <button class="schedule-btn schedule-btn-success" onclick="exportToExcel()">å¯¼å‡º Excel</button>
                    <button class="schedule-btn schedule-btn-secondary" onclick="clearAllCourses()">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
                <div class="schedule-table-container" id="scheduleContainer">
                    <table class="schedule-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="schedule-time-column">æ—¶é—´</th>
                                <th id="header-0">å‘¨ä¸€<div class="schedule-date-subtitle" id="date-0"></div></th>
                                <th id="header-1">å‘¨äºŒ<div class="schedule-date-subtitle" id="date-1"></div></th>
                                <th id="header-2">å‘¨ä¸‰<div class="schedule-date-subtitle" id="date-2"></div></th>
                                <th id="header-3">å‘¨å››<div class="schedule-date-subtitle" id="date-3"></div></th>
                                <th id="header-4">å‘¨äº”<div class="schedule-date-subtitle" id="date-4"></div></th>
                                <th id="header-5">å‘¨å…­<div class="schedule-date-subtitle" id="date-5"></div></th>
                                <th id="header-6">å‘¨æ—¥<div class="schedule-date-subtitle" id="date-6"></div></th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- æœˆè®¡åˆ’æ¨¡å— -->
            <div id="schedule-module-month" class="hidden">
                <div class="schedule-date-controls">
                    <button onclick="changeMonth(-1)">&lt; ä¸Šæœˆ</button>
                    <span class="schedule-date-display" id="monthDisplay"></span>
                    <button onclick="changeMonth(1)">ä¸‹æœˆ &gt;</button>
                    <button class="schedule-btn-secondary" onclick="goToThisMonth()">æœ¬æœˆ</button>
                </div>
                <div class="schedule-controls-bar">
                    <button class="schedule-btn schedule-btn-success" onclick="openMonthPlanModal()">â• æ·»åŠ è®¡åˆ’</button>
                    <button class="schedule-btn" onclick="exportMonthPlanToPDF()">ğŸ“„ å¯¼å‡º PDF</button>
                    <button class="schedule-btn schedule-btn-success" onclick="exportMonthPlanToExcel()">ğŸ“Š å¯¼å‡º Excel</button>
                </div>
                <div class="month-plan-layout" style="display: flex; gap: 20px; margin: 0 20px;">
                    <!-- å·¦ä¾§æ—¥å† -->
                    <div class="month-calendar-container" id="monthCalendarContainer" style="flex: 1; margin: 0;">
                        <div class="month-calendar" id="monthCalendar">
                        </div>
                    </div>
                    <!-- å³ä¾§è®¡åˆ’è¯¦æƒ… -->
                    <div class="month-plan-detail-panel" id="monthPlanDetail" style="display: none; width: 350px; flex-shrink: 0;">
                        <div style="background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); padding: 20px; height: 100%; box-sizing: border-box;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin: 0;" id="selectedDateTitle"></h3>
                                <button class="schedule-btn schedule-btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="openMonthPlanModal(currentSelectedDate)">â• æ·»åŠ </button>
                            </div>
                            <div class="month-plan-list" id="monthPlanList" style="max-height: 500px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="schedule-modal" id="courseModal">
            <div class="schedule-modal-content">
                <h2 id="modalTitle">æ·»åŠ è¯¾ç¨‹</h2>
                <div class="schedule-form-group">
                    <label>è¯¾ç¨‹åç§°</label>
                    <input type="text" id="courseName" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°">
                </div>
                <div class="schedule-form-group">
                    <label>ä¸Šè¯¾åœ°ç‚¹</label>
                    <input type="text" id="courseLocation" placeholder="è¯·è¾“å…¥ä¸Šè¯¾åœ°ç‚¹">
                </div>
                <div class="schedule-form-group">
                    <label>æ•™å¸ˆ</label>
                    <input type="text" id="courseTeacher" placeholder="è¯·è¾“å…¥æ•™å¸ˆå§“å">
                </div>
                <div class="schedule-form-group">
                    <label>é€‰æ‹©é¢œè‰²</label>
                    <div class="schedule-color-picker" id="colorPicker">
                    </div>
                </div>
                <div class="schedule-modal-buttons">
                    <button class="schedule-btn schedule-btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="schedule-btn" onclick="saveCourse()">ä¿å­˜</button>
                </div>
                <div class="schedule-modal-buttons" id="deleteButtonContainer" style="display: none;">
                    <button class="schedule-btn schedule-btn-danger" onclick="deleteCourse()">åˆ é™¤è¯¾ç¨‹</button>
                </div>
            </div>
        </div>
        
        <!-- æœˆè®¡åˆ’æ¨¡æ€æ¡† -->
        <div class="schedule-modal" id="monthPlanModal">
            <div class="schedule-modal-content">
                <h2 id="monthPlanModalTitle">æ·»åŠ æœˆè®¡åˆ’</h2>
                <div class="schedule-form-group">
                    <label>è®¡åˆ’æ ‡é¢˜</label>
                    <input type="text" id="monthPlanTitle" placeholder="è¯·è¾“å…¥è®¡åˆ’æ ‡é¢˜">
                </div>
                <div class="schedule-form-group">
                    <label>è®¡åˆ’å†…å®¹</label>
                    <textarea id="monthPlanContent" rows="4" placeholder="è¯·è¾“å…¥è®¡åˆ’å†…å®¹" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; resize:vertical;"></textarea>
                </div>
                <div class="schedule-form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="monthPlanDate">
                </div>
                <div class="schedule-form-group">
                    <label>é€‰æ‹©é¢œè‰²</label>
                    <div class="schedule-color-picker" id="monthPlanColorPicker">
                    </div>
                </div>
                <div class="schedule-modal-buttons">
                    <button class="schedule-btn schedule-btn-secondary" onclick="closeMonthPlanModal()">å–æ¶ˆ</button>
                    <button class="schedule-btn" onclick="saveMonthPlan()">ä¿å­˜</button>
                </div>
                <div class="schedule-modal-buttons" id="monthPlanDeleteContainer" style="display: none;">
                    <button class="schedule-btn schedule-btn-danger" onclick="deleteMonthPlan()">åˆ é™¤è®¡åˆ’</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ”¶å…¥è®°å½• -->
    <div class="tab-content" id="income">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                è¿”å›ä¸»é¡µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- æœˆä»½åˆ‡æ¢ -->
            <div class="flex items-center justify-between mb-6">
                <button onclick="changeIncomeMonth(-1)" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                    <i class="fa fa-chevron-left text-gray-600"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800" id="income-month-title">2025å¹´01æœˆ</h2>
                <button onclick="changeIncomeMonth(1)" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                    <i class="fa fa-chevron-right text-gray-600"></i>
                </button>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="income-stats-card mb-6">
                <div class="income-stat-item">
                    <div class="income-stat-label">æ€»è¯¾æ—¶</div>
                    <div class="income-stat-value" id="income-total-hours">0h</div>
                </div>
                <div class="income-stat-item">
                    <div class="income-stat-label">è¯¾æ—¶æ”¶å…¥</div>
                    <div class="income-stat-value" id="income-total-amount">0å…ƒ</div>
                </div>
                <div class="income-stat-item">
                    <div class="income-stat-label">è¡¥è´´+å…¶ä»–</div>
                    <div class="income-stat-value" id="income-total-bonus">0å…ƒ</div>
                </div>
                <div class="income-stat-item">
                    <div class="income-stat-label">æ€»æ”¶å…¥</div>
                    <div class="income-stat-value income-total-highlight" id="income-grand-total">0å…ƒ</div>
                </div>
            </div>

            <!-- æ—¥å†ç½‘æ ¼ -->
            <div class="income-calendar-container">
                <!-- æ˜ŸæœŸæ ‡é¢˜ -->
                <div class="income-weekdays">
                    <div class="income-weekday">ä¸€</div>
                    <div class="income-weekday">äºŒ</div>
                    <div class="income-weekday">ä¸‰</div>
                    <div class="income-weekday">å››</div>
                    <div class="income-weekday">äº”</div>
                    <div class="income-weekday income-weekend">å…­</div>
                    <div class="income-weekday income-weekend">æ—¥</div>
                </div>
                <!-- æ—¥æœŸç½‘æ ¼ -->
                <div class="income-calendar-grid" id="income-calendar-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex gap-4 mt-6">
                <button onclick="exportIncomeToExcel()" class="flex-1 py-3 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa fa-file-excel-o"></i>å¯¼å‡ºExcel
                </button>
                <button onclick="showIncomeSettings()" class="flex-1 py-3 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa fa-cog"></i>è®¾ç½®è¯¾æ—¶è´¹
                </button>
            </div>
        </main>

        <!-- æ”¶å…¥è®°å½•æ¨¡æ€æ¡† -->
        <div class="income-modal" id="income-modal">
            <div class="income-modal-content">
                <div class="income-modal-header">
                    <h3 id="income-modal-title">è®°å½•æ”¶å…¥</h3>
                    <button onclick="closeIncomeModal()" class="income-modal-close">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="income-modal-body">
                    <div class="income-form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="income-date" readonly>
                    </div>
                    <div class="income-form-group">
                        <label>å·¥ä½œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" id="income-hours" step="0.5" min="0" max="24" placeholder="ä¾‹å¦‚ï¼š2.5">
                    </div>
                    <div class="income-form-group">
                        <label>è¯¾æ—¶è´¹å•ä»·ï¼ˆå…ƒ/å°æ—¶ï¼‰</label>
                        <input type="number" id="income-rate" step="1" min="0" placeholder="ä¾‹å¦‚ï¼š200">
                    </div>
                    <div class="income-form-group">
                        <label>è¡¥è´´/å…¶ä»–æ”¶å…¥ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="income-bonus" step="1" min="0" placeholder="ä¾‹å¦‚ï¼š100">
                    </div>
                    <div class="income-form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="income-note" placeholder="ä¾‹å¦‚ï¼šåˆä¸‰æ•°å­¦ä¸€å¯¹ä¸€">
                    </div>
                    <div class="income-form-summary">
                        <div class="income-form-summary-item">
                            <span>è¯¾æ—¶æ”¶å…¥ï¼š</span>
                            <span id="income-calc-amount">0å…ƒ</span>
                        </div>
                        <div class="income-form-summary-item income-form-total">
                            <span>å½“æ—¥æ€»æ”¶å…¥ï¼š</span>
                            <span id="income-calc-total">0å…ƒ</span>
                        </div>
                    </div>
                </div>
                <div class="income-modal-footer">
                    <button onclick="deleteIncomeRecord()" class="income-btn-delete" id="income-btn-delete" style="display:none;">
                        <i class="fa fa-trash"></i>åˆ é™¤
                    </button>
                    <div class="income-modal-actions">
                        <button onclick="closeIncomeModal()" class="income-btn-cancel">å–æ¶ˆ</button>
                        <button onclick="saveIncomeRecord()" class="income-btn-save">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®æ¨¡æ€æ¡† -->
        <div class="income-modal" id="income-settings-modal">
            <div class="income-modal-content">
                <div class="income-modal-header">
                    <h3>è®¾ç½®é»˜è®¤è¯¾æ—¶è´¹</h3>
                    <button onclick="closeIncomeSettings()" class="income-modal-close">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="income-modal-body">
                    <div class="income-form-group">
                        <label>é»˜è®¤è¯¾æ—¶è´¹å•ä»·ï¼ˆå…ƒ/å°æ—¶ï¼‰</label>
                        <input type="number" id="income-default-rate" step="1" min="0" placeholder="ä¾‹å¦‚ï¼š200">
                    </div>
                    <p class="text-sm text-gray-500 mt-2">è®¾ç½®åï¼Œæ–°å»ºè®°å½•æ—¶å°†è‡ªåŠ¨å¡«å……æ­¤å•ä»·</p>
                </div>
                <div class="income-modal-footer">
                    <button onclick="closeIncomeSettings()" class="income-btn-cancel">å–æ¶ˆ</button>
                    <button onclick="saveIncomeSettings()" class="income-btn-save">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å‡½æ•°ç»˜åˆ¶ç¨‹åº -->
    <div class="tab-content" id="function">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                è¿”å›ä¸»é¡µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- æ¨¡å—é€‰é¡¹å¡ -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="tab-graph" class="tab-active py-3 px-4 md:px-6 text-base md:text-lg cursor-pointer transition-all duration-200">å‡½æ•°å›¾åƒç»˜åˆ¶</button>
                <button id="tab-equation" class="py-3 px-4 md:px-6 text-base md:text-lg text-light hover:text-primary cursor-pointer transition-all duration-200">æ–¹ç¨‹ï¼ˆç»„ï¼‰æ±‚è§£</button>
            </div>

            <!-- å‡½æ•°å›¾åƒç»˜åˆ¶æ¨¡å— -->
            <section id="module-graph" class="block">
                <div class="force-horizontal gap-6 md:gap-8">
                    <!-- å·¦ä¾§å‚æ•°è®¾ç½®åŒºåŸŸ -->
                    <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                        <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                            <i class="fa fa-line-chart text-primary"></i>å‡½æ•°å‚æ•°è®¾ç½®
                        </h2>
                        
                        <!-- å›¾åƒç»˜åˆ¶èŒƒå›´è®¾ç½® -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-md">
                            <h3 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                <i class="fa fa-expand text-primary"></i> å›¾åƒç»˜åˆ¶èŒƒå›´ï¼ˆä»…é™æœ¬æ¬¡ç»˜åˆ¶ï¼‰
                            </h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Xèµ·å§‹å€¼</label>
                                    <input type="number" id="x-start" value="-10" step="1" class="w-full input-apple">
                                    <input type="range" id="x-start-slider" min="-20" max="10" value="-10" step="1" class="w-full mt-2">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Xç»“æŸå€¼</label>
                                    <input type="number" id="x-end" value="10" step="1" class="w-full input-apple">
                                    <input type="range" id="x-end-slider" min="-10" max="20" value="10" step="1" class="w-full mt-2">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">ä»…æ§åˆ¶æœ¬æ¬¡å‡½æ•°å›¾åƒçš„ç»˜åˆ¶èŒƒå›´ï¼Œä¸å½±å“åæ ‡è½´èŒƒå›´</p>
                        </div>
                        
                        <!-- å‡½æ•°ç±»å‹é€‰æ‹© -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å‡½æ•°ç±»å‹</label>
                            <select id="function-type" class="w-full input-apple">
                                <option value="direct">æ­£æ¯”ä¾‹å‡½æ•° (y = kx)</option>
                                <option value="linear">ä¸€æ¬¡å‡½æ•° (y = kx + b)</option>
                                <option value="quadratic">äºŒæ¬¡å‡½æ•° (y = axÂ² + bx + c)</option>
                                <option value="hyperbola">åæ¯”ä¾‹å‡½æ•°ï¼ˆåŒæ›²çº¿ï¼‰(y = k/x)</option>
                                <option value="power">å¹‚å‡½æ•° (y = xâ¿)</option>
                                <option value="exponential">æŒ‡æ•°å‡½æ•° (y = aË£)</option>
                                <option value="logarithmic">å¯¹æ•°å‡½æ•° (y = logâ‚x)</option>
                                <option value="sine">æ­£å¼¦å‡½æ•° (y = A sin(Ï‰x + Ï†) + d)</option>
                                <option value="cosine">ä½™å¼¦å‡½æ•° (y = A cos(Ï‰x + Ï†) + d)</option>
                                <option value="ellipse">æ¤­åœ† (xÂ²/aÂ² + yÂ²/bÂ² = 1)</option>
                                <option value="conic-hyperbola">åœ†é”¥æ›²çº¿åŒæ›²çº¿ (xÂ²/aÂ² - yÂ²/bÂ² = 1)</option>
                            </select>
                        </div>

                        <!-- ç³»æ•°è¾“å…¥æ¡† - åŠ¨æ€æ˜¾ç¤º -->
                        <div id="coefficient-inputs" class="space-y-3 mb-5">
                            <!-- æ­£æ¯”ä¾‹å‡½æ•° -->
                            <div id="coeff-direct" class="block space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">kï¼ˆæ¯”ä¾‹ç³»æ•°ï¼Œkâ‰ 0ï¼‰</label>
                                    <input type="number" id="k-direct" value="1" step="0.5" class="w-full input-apple">
                                    <input type="range" id="k-direct-slider" min="-10" max="10" value="1" step="0.5" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = kx</div>
                            </div>
                            <!-- ä¸€æ¬¡å‡½æ•° -->
                            <div id="coeff-linear" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">kï¼ˆæ–œç‡ï¼Œkâ‰ 0ï¼‰</label>
                                        <input type="number" id="k" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="k-slider" min="-10" max="10" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">bï¼ˆæˆªè·ï¼‰</label>
                                        <input type="number" id="b" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="b-slider" min="-10" max="10" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = kx + b</div>
                            </div>
                            <!-- äºŒæ¬¡å‡½æ•° -->
                            <div id="coeff-quadratic" class="hidden space-y-3">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">a (aâ‰ 0)</label>
                                        <input type="number" id="a" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="a-slider" min="-5" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">b</label>
                                        <input type="number" id="bq" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="bq-slider" min="-10" max="10" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">c</label>
                                        <input type="number" id="c" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="c-slider" min="-10" max="10" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = axÂ² + bx + c</div>
                            </div>
                            <!-- åæ¯”ä¾‹å‡½æ•° -->
                            <div id="coeff-hyperbola" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">kï¼ˆkâ‰ 0ï¼‰</label>
                                    <input type="number" id="kh" value="1" step="0.5" class="w-full input-apple">
                                    <input type="range" id="kh-slider" min="-10" max="10" value="1" step="0.5" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = k/xï¼ˆåŒæ›²çº¿ï¼Œè‡ªåŠ¨ç»˜åˆ¶å®Œæ•´å·¦å³åˆ†æ”¯ï¼‰</div>
                            </div>
                            <!-- å¹‚å‡½æ•° -->
                            <div id="coeff-power" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">nï¼ˆæŒ‡æ•°ï¼Œå®æ•°ï¼‰</label>
                                    <input type="number" id="n" value="2" step="0.5" class="w-full input-apple">
                                    <input type="range" id="n-slider" min="-3" max="5" value="2" step="0.5" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = xâ¿ï¼ˆåˆé«˜ä¸­å¸¸ç”¨n=1,2,3,1/2,-1ç­‰ï¼‰</div>
                            </div>
                            <!-- æŒ‡æ•°å‡½æ•° -->
                            <div id="coeff-exponential" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">aï¼ˆåº•æ•°ï¼Œa>0ä¸”aâ‰ 1ï¼‰</label>
                                    <input type="number" id="a-exp" value="2" step="0.1" min="0.1" max="10" class="w-full input-apple">
                                    <input type="range" id="a-exp-slider" min="0.1" max="10" value="2" step="0.1" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = aË£ï¼ˆa>0ï¼Œaâ‰ 1ï¼Œå®šä¹‰åŸŸRï¼Œå€¼åŸŸ(0,+âˆ)ï¼‰</div>
                            </div>
                            <!-- å¯¹æ•°å‡½æ•° -->
                            <div id="coeff-logarithmic" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">aï¼ˆåº•æ•°ï¼Œa>0ä¸”aâ‰ 1ï¼‰</label>
                                    <input type="number" id="a-log" value="10" step="0.1" min="0.1" max="10" class="w-full input-apple">
                                    <input type="range" id="a-log-slider" min="0.1" max="10" value="10" step="0.1" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = logâ‚xï¼ˆa>0ï¼Œaâ‰ 1ï¼Œå®šä¹‰åŸŸ(0,+âˆ)ï¼Œå€¼åŸŸRï¼‰</div>
                            </div>
                            <!-- æ¤­åœ† -->
                            <div id="coeff-ellipse" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aï¼ˆé•¿åŠè½´ï¼Œa>0ï¼‰</label>
                                        <input type="number" id="a-ellipse" value="3" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="a-ellipse-slider" min="0.1" max="10" value="3" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">bï¼ˆçŸ­åŠè½´ï¼Œb>0ï¼‰</label>
                                        <input type="number" id="b-ellipse" value="2" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="b-ellipse-slider" min="0.1" max="10" value="2" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šxÂ²/aÂ² + yÂ²/bÂ² = 1ï¼ˆä¸­å¿ƒåœ¨åŸç‚¹çš„æ¤­åœ†ï¼‰</div>
                            </div>
                            <!-- åœ†é”¥æ›²çº¿åŒæ›²çº¿ -->
                            <div id="coeff-conic-hyperbola" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aï¼ˆå®åŠè½´ï¼Œa>0ï¼‰</label>
                                        <input type="number" id="a-hyperbola" value="2" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="a-hyperbola-slider" min="0.1" max="10" value="2" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">bï¼ˆè™šåŠè½´ï¼Œb>0ï¼‰</label>
                                        <input type="number" id="b-hyperbola" value="1" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="b-hyperbola-slider" min="0.1" max="10" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šxÂ²/aÂ² - yÂ²/bÂ² = 1ï¼ˆä¸­å¿ƒåœ¨åŸç‚¹çš„åŒæ›²çº¿ï¼‰</div>
                            </div>
                            <!-- æ­£å¼¦å‡½æ•° - å¢å¼ºç‰ˆ -->
                            <div id="coeff-sine" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Aï¼ˆæŒ¯å¹…ï¼‰</label>
                                        <input type="number" id="A-sin" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="A-sin-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Ï‰ï¼ˆè§’é¢‘ç‡ï¼‰</label>
                                        <input type="number" id="w-sin" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="w-sin-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Ï†ï¼ˆç›¸ä½ï¼Œå¼§åº¦ï¼‰</label>
                                        <input type="number" id="phi-sin" value="0" step="0.1" class="w-full input-apple">
                                        <input type="range" id="phi-sin-slider" min="-6.28" max="6.28" value="0" step="0.1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">dï¼ˆå‚ç›´ä½ç§»ï¼‰</label>
                                        <input type="number" id="d-sin" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="d-sin-slider" min="-5" max="5" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = A sin(Ï‰x + Ï†) + dï¼ˆå‘¨æœŸT=2Ï€/|Ï‰|ï¼‰</div>
                            </div>
                            <!-- ä½™å¼¦å‡½æ•° - å¢å¼ºç‰ˆ -->
                            <div id="coeff-cosine" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Aï¼ˆæŒ¯å¹…ï¼‰</label>
                                        <input type="number" id="A-cos" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="A-cos-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Ï‰ï¼ˆè§’é¢‘ç‡ï¼‰</label>
                                        <input type="number" id="w-cos" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="w-cos-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Ï†ï¼ˆç›¸ä½ï¼Œå¼§åº¦ï¼‰</label>
                                        <input type="number" id="phi-cos" value="0" step="0.1" class="w-full input-apple">
                                        <input type="range" id="phi-cos-slider" min="-6.28" max="6.28" value="0" step="0.1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">dï¼ˆå‚ç›´ä½ç§»ï¼‰</label>
                                        <input type="number" id="d-cos" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="d-cos-slider" min="-5" max="5" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">å‡½æ•°å½¢å¼ï¼šy = A cos(Ï‰x + Ï†) + dï¼ˆå‘¨æœŸT=2Ï€/|Ï‰|ï¼‰</div>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex gap-2 md:gap-3 mb-3">
                            <button id="draw-graph" class="flex-1 bg-primary text-white py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1">
                                <i class="fa fa-paint-brush"></i> æ·»åŠ å›¾åƒ
                            </button>
                            <button id="reset-graph" class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1">
                                <i class="fa fa-refresh"></i> æ¸…ç©ºæ‰€æœ‰
                            </button>
                        </div>
                        
                        <button id="export-pdf" class="w-full mb-3 bg-warning text-white py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1">
                            <i class="fa fa-file-pdf-o"></i> å¯¼å‡ºPDF
                        </button>
                        
                        <!-- å‡½æ•°æ ‡ç­¾æ  -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h3 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                <i class="fa fa-tags text-primary"></i> å·²ç»˜åˆ¶å‡½æ•°
                            </h3>
                            <div id="function-tags" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1">
                                <span class="text-xs text-gray-500">æš‚æ— å‡½æ•°</span>
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-3"><i class="fa fa-info-circle text-primary"></i> ç”»å¸ƒæ”¯æŒï¼šæ»‘è½®ç¼©æ”¾ | å®æ—¶åæ ‡ | å¤šå›¾åˆ é™¤</p>
                    </div>

                    <!-- å³ä¾§ç»˜å›¾åŒºåŸŸ -->
                    <div class="right-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                        <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                            <i class="fa fa-square-o text-primary"></i>å‡½æ•°å›¾åƒç”»å¸ƒ
                        </h2>
                        
                        <!-- å®æ—¶åæ ‡æç¤ºæ¡† -->
                        <div id="coord-tooltip" class="coord-tooltip hidden" style="top: 0; left: 0;">(x, y) = (0.0, 0.0)</div>
                        
                        <!-- ç”»å¸ƒå®¹å™¨ -->
                        <div class="relative w-full chart-height overflow-hidden rounded-md border border-gray-200" id="chart-container">
                            <canvas id="function-chart" class="w-full h-full"></canvas>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2 text-center">æç¤ºï¼šåŒæ›²çº¿è‡ªåŠ¨ç»˜åˆ¶å®Œæ•´åˆ†æ”¯ï¼›ä¸‰è§’å‡½æ•°æ˜¾ç¤º2ä¸ªå‘¨æœŸï¼›å›¾åƒé¢œè‰²ä¸é‡å¤</p>
                    </div>
                </div>
            </section>

            <!-- 2. æ–¹ç¨‹ï¼ˆç»„ï¼‰æ±‚è§£æ¨¡å— -->
            <section id="module-equation" class="hidden">
                <div class="bg-white rounded-xl p-4 md:p-6 card-shadow">
                    <!-- æ–¹ç¨‹ç±»å‹å­é€‰é¡¹å¡ -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="tab-single" class="tab-active py-3 px-4 md:px-6 text-sm md:text-base cursor-pointer transition-all duration-200">ä¸€å…ƒæ–¹ç¨‹ï¼ˆä¸€æ¬¡/äºŒæ¬¡ï¼‰</button>
                        <button id="tab-system" class="py-3 px-4 md:px-6 text-sm md:text-base text-light hover:text-primary cursor-pointer transition-all duration-200">äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹ç»„</button>
                    </div>

                    <div class="force-horizontal gap-6 md:gap-8">
                        <!-- å·¦ä¾§è¾“å…¥åŒºåŸŸ -->
                        <div class="left-panel">
                            <!-- ä¸€å…ƒæ–¹ç¨‹è¾“å…¥ -->
                            <div id="single-equation" class="block">
                                <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                                    <i class="fa fa-pencil text-primary"></i>ä¸€å…ƒæ–¹ç¨‹å‚æ•°
                                </h2>
                                <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ–¹ç¨‹ç±»å‹</label>
                            <select id="single-type" class="w-full input-apple">
                                    <option value="one">ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹ (ax + b = 0)</option>
                                    <option value="two">ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹ (axÂ² + bx + c = 0)</option>
                                </select>
                                </div>
                                <!-- ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹ç³»æ•° -->
                            <div id="single-one-coeff" class="block space-y-3 mb-5">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aï¼ˆaâ‰ 0ï¼‰</label>
                                        <input type="number" id="sa1" value="2" step="1" class="w-full input-apple">
                                        <input type="range" id="sa1-slider" min="-10" max="10" value="2" step="1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">b</label>
                                        <input type="number" id="sb1" value="4" step="1" class="w-full input-apple">
                                        <input type="range" id="sb1-slider" min="-20" max="20" value="4" step="1" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">æ–¹ç¨‹å½¢å¼ï¼šax + b = 0</div>
                            </div>
                            <!-- ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹ç³»æ•° -->
                            <div id="single-two-coeff" class="hidden space-y-3 mb-5">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aï¼ˆaâ‰ 0ï¼‰</label>
                                        <input type="number" id="sa2" value="1" step="1" class="w-full input-apple">
                                        <input type="range" id="sa2-slider" min="-5" max="5" value="1" step="1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">b</label>
                                        <input type="number" id="sb2" value="-3" step="1" class="w-full input-apple">
                                        <input type="range" id="sb2-slider" min="-10" max="10" value="-3" step="1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">c</label>
                                        <input type="number" id="sc2" value="2" step="1" class="w-full input-apple">
                                        <input type="range" id="sc2-slider" min="-10" max="10" value="2" step="1" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">æ–¹ç¨‹å½¢å¼ï¼šaxÂ² + bx + c = 0</div>
                            </div>
                            </div>

                            <!-- äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹ç»„è¾“å…¥ -->
                            <div id="system-equation" class="hidden">
                                <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                                    <i class="fa fa-pencil-square-o text-primary"></i>äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹ç»„å‚æ•°
                                </h2>
                                <div class="space-y-3 mb-5">
                                    <div class="p-3 border border-gray-200 rounded-xl">
                                        <p class="text-sm font-medium mb-2">æ–¹ç¨‹â‘ ï¼šaâ‚x + bâ‚y = câ‚</p>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div>
                                                <input type="number" id="a1" value="1" step="1" placeholder="aâ‚" class="w-full input-apple">
                                                <input type="range" id="a1-slider" min="-10" max="10" value="1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="b1" value="1" step="1" placeholder="bâ‚" class="w-full input-apple">
                                                <input type="range" id="b1-slider" min="-10" max="10" value="1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="c1" value="3" step="1" placeholder="câ‚" class="w-full input-apple">
                                                <input type="range" id="c1-slider" min="-20" max="20" value="3" step="1" class="w-full mt-2">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-3 border border-gray-200 rounded-xl">
                                        <p class="text-sm font-medium mb-2">æ–¹ç¨‹â‘¡ï¼šaâ‚‚x + bâ‚‚y = câ‚‚</p>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div>
                                                <input type="number" id="a2" value="1" step="1" placeholder="aâ‚‚" class="w-full input-apple">
                                                <input type="range" id="a2-slider" min="-10" max="10" value="1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="b2" value="-1" step="1" placeholder="bâ‚‚" class="w-full input-apple">
                                                <input type="range" id="b2-slider" min="-10" max="10" value="-1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="c2" value="1" step="1" placeholder="câ‚‚" class="w-full input-apple">
                                                <input type="range" id="c2-slider" min="-20" max="20" value="1" step="1" class="w-full mt-2">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500"><i class="fa fa-info-circle text-primary"></i> è§£é¢˜æ­¥éª¤é‡‡ç”¨ä¸­å­¦è¯¾æœ¬ã€ŒåŠ å‡æ¶ˆå…ƒæ³•ã€</p>
                            </div>

                            <!-- æ±‚è§£æŒ‰é’® -->
                            <button id="solve-equation" class="w-full mt-4 bg-primary text-white py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1 text-base">
                                <i class="fa fa-calculator"></i> æ±‚è§£å¹¶æ˜¾ç¤ºè¿‡ç¨‹
                            </button>
                        </div>

                        <!-- å³ä¾§ç»“æœåŒºåŸŸ -->
                        <div class="right-panel bg-neutral rounded-xl p-5 md:p-6 border border-gray-200">
                            <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                                <i class="fa fa-file-text-o text-primary"></i>è§£é¢˜è¿‡ç¨‹ & æ³¨æ„äº‹é¡¹
                            </h2>
                            <div id="solution-result" class="space-y-4 h-full">
                                <div class="text-center text-gray-500 py-8 md:py-10">
                                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                                    <p>è¯·é€‰æ‹©æ–¹ç¨‹ç±»å‹å¹¶è¾“å…¥ç³»æ•°ï¼Œç‚¹å‡»æ±‚è§£æŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                                    <p class="text-xs mt-2 text-gray-400">è§£é¢˜æ­¥éª¤ä¸¥æ ¼éµå¾ªä¸­å­¦æ•°å­¦ä¹¦å†™è§„èŒƒ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- å‡ ä½•ç»˜å›¾ -->
    <div class="tab-content" id="geometry">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                è¿”å›ä¸»é¡µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <div class="force-horizontal gap-6 md:gap-8">
                <!-- å·¦ä¾§å·¥å…·æ  -->
                <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                    <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-pencil-square-o text-primary"></i>ç»˜å›¾å·¥å…·
                    </h2>
                    
                    <!-- å›¾å½¢ç±»å‹é€‰æ‹© -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å›¾å½¢ç±»å‹</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="geometry-tool-btn active p-2 rounded-lg border-2 border-primary bg-primary/10 text-primary text-sm" data-tool="select">
                                <i class="fa fa-mouse-pointer block mb-1"></i>é€‰æ‹©
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="point">
                                <i class="fa fa-dot-circle-o block mb-1"></i>ç‚¹
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="line">
                                <i class="fa fa-minus block mb-1"></i>ç›´çº¿
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="segment">
                                <i class="fa fa-arrows-h block mb-1"></i>çº¿æ®µ
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="circle">
                                <i class="fa fa-circle-o block mb-1"></i>åœ†
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="rectangle">
                                <i class="fa fa-square-o block mb-1"></i>çŸ©å½¢
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="triangle">
                                <i class="fa fa-play fa-rotate-270 block mb-1"></i>ä¸‰è§’å½¢
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="polygon">
                                <i class="fa fa-star-o block mb-1"></i>å¤šè¾¹å½¢
                            </button>
                        </div>
                    </div>

                    <!-- å±æ€§è®¾ç½® -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-md">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">å›¾å½¢å±æ€§</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">çº¿æ¡é¢œè‰²</label>
                                <div class="flex gap-2 flex-wrap">
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#000000" style="background: #000000;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#ff0000" style="background: #ff0000;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#00ff00" style="background: #00ff00;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#0000ff" style="background: #0000ff;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-primary" data-color="#0071e3" style="background: #0071e3;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#ff9500" style="background: #ff9500;"></button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">çº¿æ¡ç²—ç»†</label>
                                <input type="range" id="geometry-line-width" min="1" max="10" value="2" class="w-full">
                                <span id="geometry-line-width-value" class="text-xs text-gray-500">2px</span>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">å¡«å……é¢œè‰²ï¼ˆå¯é€‰ï¼‰</label>
                                <div class="flex gap-2 flex-wrap">
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-primary bg-transparent" data-fill="transparent"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#ff000033" style="background: #ff000033;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#00ff0033" style="background: #00ff0033;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#0000ff33" style="background: #0000ff33;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#0071e333" style="background: #0071e333;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#ff950033" style="background: #ff950033;"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="space-y-2">
                        <button id="geometry-clear" class="w-full py-2 px-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm">
                            <i class="fa fa-trash-o mr-1"></i>æ¸…ç©ºç”»å¸ƒ
                        </button>
                        <button id="geometry-undo" class="w-full py-2 px-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm">
                            <i class="fa fa-undo mr-1"></i>æ’¤é”€
                        </button>
                        <button id="geometry-export" class="w-full py-2 px-3 rounded-lg bg-primary text-white hover:bg-primary/90 text-sm">
                            <i class="fa fa-download mr-1"></i>å¯¼å‡ºå›¾ç‰‡
                        </button>
                    </div>

                    <!-- ä½¿ç”¨è¯´æ˜ -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-md text-xs text-blue-700">
                        <p class="font-medium mb-1"><i class="fa fa-info-circle mr-1"></i>ä½¿ç”¨è¯´æ˜ï¼š</p>
                        <ul class="space-y-1 ml-4 list-disc">
                            <li><strong>é€‰æ‹©å·¥å…·</strong>ï¼šç‚¹å‡»é€‰ä¸­å›¾å½¢ï¼Œæ‹–æ‹½ç§»åŠ¨ä½ç½®</li>
                            <li><strong>ç‚¹</strong>ï¼šç‚¹å‡»æ”¾ç½®</li>
                            <li><strong>çº¿/çº¿æ®µ</strong>ï¼šæ‹–æ‹½ç»˜åˆ¶</li>
                            <li><strong>åœ†</strong>ï¼šä»åœ†å¿ƒæ‹–æ‹½åˆ°è¾¹ç¼˜</li>
                            <li><strong>çŸ©å½¢/ä¸‰è§’å½¢</strong>ï¼šæ‹–æ‹½ç»˜åˆ¶</li>
                            <li><strong>å¤šè¾¹å½¢</strong>ï¼šç‚¹å‡»æ·»åŠ é¡¶ç‚¹ï¼ŒåŒå‡»å®Œæˆ</li>
                            <li><strong>å³é”®</strong>ï¼šå–æ¶ˆå½“å‰ç»˜åˆ¶</li>
                        </ul>
                    </div>
                </div>

                <!-- å³ä¾§ç”»å¸ƒåŒºåŸŸ -->
                <div class="right-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg md:text-xl font-semibold flex items-center gap-2">
                            <i class="fa fa-paint-brush text-primary"></i>ç”»å¸ƒ
                        </h2>
                        <div class="text-sm text-gray-500">
                            <span id="geometry-coords">åæ ‡: (0, 0)</span>
                        </div>
                    </div>
                    <div class="relative bg-white border-2 border-gray-200 rounded-lg overflow-hidden" style="height: 600px;">
                        <canvas id="geometry-canvas" class="w-full h-full cursor-crosshair"></canvas>
                        <div id="geometry-grid-toggle" class="absolute top-2 right-2 p-2 bg-white/80 rounded-lg cursor-pointer hover:bg-white">
                            <i class="fa fa-th text-gray-600"></i>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== é…ç½®å’Œå¸¸é‡ ==========
        const CONFIG = {
            DEBOUNCE_WAIT: 300,
            STORAGE_KEYS: {
                ANSWER_SHEET: 'answerSheetSettings',
                TOMATO: 'tomatoStats',
                SCHEDULE: 'scheduleData',
                THEME: 'themePreference'
            },
            COLORS: {
                PRIMARY: '#0071e3',
                SUCCESS: '#34c759',
                WARNING: '#FF9500',
                ERROR: '#ff3b30',
                GRAY_200: '#e5e7eb',
                GRAY_700: '#374151'
            }
        };

        // ========== å·¥å…·å‡½æ•°åº“ ==========
        
        function debounce(func, wait = CONFIG.DEBOUNCE_WAIT) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit = 100) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        function $(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`Element with id "${id}" not found`);
            }
            return el;
        }

        function createElement(tag, options = {}) {
            const el = document.createElement(tag);
            if (options.className) el.className = options.className;
            if (options.innerHTML) el.innerHTML = options.innerHTML;
            if (options.style) Object.assign(el.style, options.style);
            if (options.dataset) {
                Object.entries(options.dataset).forEach(([key, value]) => {
                    el.dataset[key] = value;
                });
            }
            return el;
        }

        function formatNumber(num, decimals = 2) {
            return Number(num).toFixed(decimals);
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = createElement('div', {
                style: {
                    position: 'fixed',
                    top: '80px',
                    right: '20px',
                    padding: '16px 24px',
                    borderRadius: '12px',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.15)',
                    zIndex: '9999',
                    animation: 'fadeIn 0.3s ease-out',
                    background: type === 'success' ? CONFIG.COLORS.SUCCESS : 
                               type === 'error' ? CONFIG.COLORS.ERROR : 
                               type === 'warning' ? CONFIG.COLORS.WARNING : 
                               CONFIG.COLORS.PRIMARY,
                    color: 'white',
                    fontWeight: '500',
                    maxWidth: '400px',
                    wordWrap: 'break-word'
                }
            });
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.warn('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
                showNotification('æ•°æ®ä¿å­˜å¤±è´¥', 'error');
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.warn('ä»localStorageè¯»å–å¤±è´¥:', error);
                return defaultValue;
            }
        }

        function clearStorage(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.warn('æ¸…é™¤localStorageå¤±è´¥:', error);
                return false;
            }
        }

        // ========== ä¸»é¢˜ç³»ç»Ÿ ==========
        function initTheme() {
            const savedTheme = loadFromStorage(CONFIG.STORAGE_KEYS.THEME, 'light');
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            saveToStorage(CONFIG.STORAGE_KEYS.THEME, theme);
            updateThemeButton(theme);
        }

        function updateThemeButton(theme) {
            const btn = document.querySelector('.theme-toggle-btn');
            if (btn) {
                btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            showNotification(`å·²åˆ‡æ¢åˆ°${newTheme === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}æ¨¡å¼`, 'info');
        }

        // ========== å¯¼èˆªå’Œæ ‡ç­¾åˆ‡æ¢ ==========
        
        function switchToTab(tabId) {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');
            const targetTab = document.querySelector(`[data-tab="${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (!targetTab || !targetContent) {
                console.error(`Tab "${tabId}" not found`);
                showNotification('é¡µé¢åˆ‡æ¢å¤±è´¥', 'error');
                return;
            }
            
            tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            contents.forEach(c => c.classList.remove('active'));
            
            targetTab.classList.add('active');
            targetTab.setAttribute('aria-selected', 'true');
            targetContent.classList.add('active');
            
            // åˆ‡æ¢åˆ°å‡ ä½•ç»˜å›¾æ ‡ç­¾æ—¶é‡æ–°åˆå§‹åŒ–ç”»å¸ƒ
            if (tabId === 'geometry') {
                setTimeout(() => {
                    resizeGeometryCanvas();
                    redrawGeometryCanvas();
                }, 50);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchTab(tabId) {
            switchToTab(tabId);
        }

        function scrollToFeatures() {
            const features = document.getElementById('features');
            if (features) {
                features.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ========== é”®ç›˜å¿«æ·é”®æ”¯æŒ ==========
        
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '5') {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                const tabs = ['home', 'answer-sheet', 'tomato', 'schedule', 'function'];
                if (tabs[tabIndex]) {
                    switchToTab(tabs[tabIndex]);
                }
            }
            
            if (e.key === 'Escape') {
                const modal = document.getElementById('courseModal');
                if (modal && modal.classList.contains('show')) {
                    closeModal();
                } else {
                    switchToTab('home');
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
        });

        // ========== äº‹ä»¶ç»‘å®šä¼˜åŒ– ==========
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchToTab(tab.dataset.tab);
            });
        });

        // ========== ç­”é¢˜å¡ç”Ÿæˆç¨‹åº ==========
        
        function saveAnswerSheetSettings() {
            const settings = {
                examName: $('examName')?.value || '',
                subject: $('subject')?.value || '',
                examTime: $('examTime')?.value || '',
                fullScore: $('fullScore')?.value || 100,
                showName: $('showName')?.checked,
                showClass: $('showClass')?.checked,
                showExamNo: $('showExamNo')?.checked,
                showSeatNo: $('showSeatNo')?.checked,
                enableMCQ: $('enableMCQ')?.checked,
                mcqCount: $('mcqCount')?.value || 12,
                mcqScore: $('mcqScore')?.value || 5,
                mcqOptions: $('mcqOptions')?.value || 4,
                enableBlank: $('enableBlank')?.checked,
                blankCount: $('blankCount')?.value || 6,
                blankScore: $('blankScore')?.value || 5,
                enableProblem: $('enableProblem')?.checked,
                problemCount: $('problemCount')?.value || 6,
                problemHeight: $('problemHeight')?.value || 180,
                showNotice: $('showNotice')?.checked,
                showSealArea: $('showSealArea')?.checked,
                enableScratchPaper: $('enableScratchPaper')?.checked,
                scratchPaperModules: $('scratchPaperModules')?.value || 2,
                scratchPaperTitle: $('scratchPaperTitle')?.value || 'æ‰“è‰çº¸'
            };
            saveToStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET, settings);
        }

        function loadAnswerSheetSettings() {
            const settings = loadFromStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET);
            if (!settings) return;
            
            Object.keys(settings).forEach(key => {
                const el = document.getElementById(key);
                if (!el) return;
                
                if (el.type === 'checkbox') {
                    el.checked = settings[key];
                } else {
                    el.value = settings[key];
                }
            });
        }

        const debouncedAnswerSheetUpdate = debounce(() => {
            generateAnswerSheet();
            saveAnswerSheetSettings();
        }, CONFIG.DEBOUNCE_WAIT);

        function exportAnswerSheetSettings() {
            const settings = loadFromStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET);
            if (!settings) {
                showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„è®¾ç½®', 'warning');
                return;
            }
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ç­”é¢˜å¡è®¾ç½®_' + new Date().toISOString().slice(0, 10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('ç­”é¢˜å¡è®¾ç½®å·²å¯¼å‡º', 'success');
        }

        function importAnswerSheetSettings(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    saveToStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET, settings);
                    loadAnswerSheetSettings();
                    generateAnswerSheet();
                    showNotification('ç­”é¢˜å¡è®¾ç½®å·²å¯¼å…¥', 'success');
                } catch (error) {
                    showNotification('å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            reader.readAsText(file);
        }

        function handleImportSettings(event) {
            const file = event.target.files[0];
            if (file) {
                importAnswerSheetSettings(file);
                event.target.value = '';
            }
        }

        window.onload = function() {
            try {
                initTheme();
                loadAnswerSheetSettings();
                
                const allInputs = document.querySelectorAll('#answer-sheet input, #answer-sheet select');
                allInputs.forEach(input => {
                    input.addEventListener('input', debouncedAnswerSheetUpdate);
                    input.addEventListener('change', debouncedAnswerSheetUpdate);
                });
                
                generateAnswerSheet();
                initTomato();
                initSchedule();
                initFunctionDrawing();
                initGeometryDrawing();
                initIncomeModule();

                console.log('âœ… ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…·åŠ è½½å®Œæˆ');
                showNotification('å·¥å…·å·²åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–é”™è¯¯:', error);
                showNotification('é¡µé¢åŠ è½½æ—¶å‡ºç°é”™è¯¯', 'error');
            }
        };

        function generateAnswerSheet() {
            try {
                const container = document.getElementById('answerSheetContainer');
                let html = '<div class="answer-sheet">';

                const examName = document.getElementById('examName').value.trim() || 'å•å…ƒæµ‹è¯•';
                const subject = document.getElementById('subject').value.trim() || 'æ•°å­¦';
                const examTime = document.getElementById('examTime').value.trim() || '90åˆ†é’Ÿ';
                const fullScore = parseInt(document.getElementById('fullScore').value) || 100;

                const showName = document.getElementById('showName').checked;
                const showClass = document.getElementById('showClass').checked;
                const showExamNo = document.getElementById('showExamNo').checked;
                const showSeatNo = document.getElementById('showSeatNo').checked;

                const enableMCQ = document.getElementById('enableMCQ').checked;
                const mcqCount = parseInt(document.getElementById('mcqCount').value) || 0;
                const mcqScore = parseInt(document.getElementById('mcqScore').value) || 0;
                const mcqOptions = parseInt(document.getElementById('mcqOptions').value) || 4;
                const mcqTotalScore = enableMCQ ? (mcqCount * mcqScore) : 0;

                const enableBlank = document.getElementById('enableBlank').checked;
                const blankCount = parseInt(document.getElementById('blankCount').value) || 0;
                const blankScore = parseInt(document.getElementById('blankScore').value) || 0;
                const blankTotalScore = enableBlank ? (blankCount * blankScore) : 0;

                const enableProblem = document.getElementById('enableProblem').checked;
                const problemCount = parseInt(document.getElementById('problemCount').value) || 0;
                const problemHeight = document.getElementById('problemHeight').value || 180;
                const problemTotalScore = fullScore - mcqTotalScore - blankTotalScore;

                const showNotice = document.getElementById('showNotice').checked;
                const showSealArea = document.getElementById('showSealArea').checked;
                const optionLabels = ['A', 'B', 'C', 'D', 'E'];
                let questionNumber = 1;

                if (showSealArea) {
                    html += '<div class="seal-area">å¯†å°åŒº</div>';
                }

                html += `
                    <div class="sheet-header">
                        <div class="sheet-title">${examName} - ${subject}ç­”é¢˜å¡</div>
                        <div style="font-size:14px; margin-top:5px;">ï¼ˆè€ƒè¯•æ—¶é—´ï¼š${examTime}  æ»¡åˆ†ï¼š${fullScore}åˆ†ï¼‰</div>
                `;

                html += '<div class="student-info">';
                if (showName) {
                    html += '<div class="info-item">å§“åï¼š<span class="info-underline"></span></div>';
                }
                if (showClass) {
                    html += '<div class="info-item">ç­çº§ï¼š<span class="info-underline"></span></div>';
                }
                if (showExamNo) {
                    html += '<div class="info-item">è€ƒå·ï¼š<span class="info-underline"></span></div>';
                }
                if (showSeatNo) {
                    html += '<div class="info-item">åº§ä½å·ï¼š<span class="info-underline"></span></div>';
                }
                html += '</div>';
                html += '</div>';

                if (showNotice) {
                    html += `
                        <div class="notice-section">
                            <div class="notice-title">âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</div>
                            <div class="notice-content">
                                1. ç­”é¢˜å‰ï¼Œè¯·å°†å§“åã€ç­çº§ã€è€ƒå·ç­‰ä¿¡æ¯å¡«å†™æ¸…æ¥šã€‚<br/>
                                2. é€‰æ‹©é¢˜ç­”æ¡ˆè¯·ç”¨2Bé“…ç¬”å¡«æ¶‚ï¼Œä¿®æ”¹æ—¶ç”¨æ©¡çš®æ“¦å¹²å‡€ã€‚<br/>
                                3. å¡«ç©ºé¢˜å’Œè§£ç­”é¢˜è¯·ç”¨é»‘è‰²ç­¾å­—ç¬”ä½œç­”ï¼Œç­”æ¡ˆå¿…é¡»å†™åœ¨ç­”é¢˜åŒºåŸŸå†…ã€‚<br/>
                                4. ä¿æŒå·é¢æ•´æ´ï¼Œä¸è¦æŠ˜å ã€ç ´æŸç­”é¢˜å¡ã€‚
                            </div>
                        </div>
                    `;
                }

                if (enableMCQ && mcqCount > 0) {
                    html += `
                        <div class="section-block">
                            <div class="section-title-main">ä¸€ã€é€‰æ‹©é¢˜ï¼ˆæœ¬å¤§é¢˜å…±${mcqCount}å°é¢˜ï¼Œæ¯å°é¢˜${mcqScore}åˆ†ï¼Œå…±${mcqTotalScore}åˆ†ï¼‰</div>
                            <div class="mcq-grid">
                    `;
                    for (let i = 1; i <= mcqCount; i++) {
                        html += `
                            <div class="mcq-item">
                                <div class="mcq-num">${questionNumber}.</div>
                                <div class="mcq-options">
                        `;
                        for (let j = 0; j < mcqOptions; j++) {
                            html += `<span class="mcq-option">${optionLabels[j]}</span>`;
                        }
                        html += `</div></div>`;
                        questionNumber++;
                    }
                    html += `</div></div>`;
                }

                if (enableBlank && blankCount > 0) {
                    html += `
                        <div class="section-block">
                            <div class="section-title-main">äºŒã€å¡«ç©ºé¢˜ï¼ˆæœ¬å¤§é¢˜å…±${blankCount}å°é¢˜ï¼Œæ¯å°é¢˜${blankScore}åˆ†ï¼Œå…±${blankTotalScore}åˆ†ï¼‰</div>
                            <div class="blank-section">
                    `;
                    for (let i = 1; i <= blankCount; i++) {
                        html += `
                            <div class="blank-item">
                                <span class="blank-num">${questionNumber}.</span>
                                <div class="blank-line"></div>
                            </div>
                        `;
                        questionNumber++;
                    }
                    html += `</div></div>`;
                }

                if (enableProblem && problemCount > 0) {
                    html += `
                        <div class="section-block">
                            <div class="section-title-main">ä¸‰ã€è§£ç­”é¢˜ï¼ˆæœ¬å¤§é¢˜å…±${problemCount}å°é¢˜ï¼Œå…±${problemTotalScore}åˆ†ï¼‰</div>
                    `;
                    for (let i = 1; i <= problemCount; i++) {
                        html += `
                            <div class="problem-item">
                                <div class="problem-header">
                                    <span class="problem-num">${questionNumber}.</span>
                                    <span class="problem-score">ï¼ˆæœ¬é¢˜ åˆ†ï¼‰</span>
                                </div>
                                <div class="problem-answer-area" style="min-height: ${problemHeight}px;">
                                    <div class="problem-score-box">å¾—åˆ†ï¼š</div>
                                </div>
                            </div>
                        `;
                        questionNumber++;
                    }
                    html += `</div>`;
                }

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                const container = document.getElementById('answerSheetContainer');
                container.innerHTML = `
                    <div style="text-align:center; padding:50px 0; color:#dc3545;">
                        <h3>ç”Ÿæˆå‡ºé”™äº†</h3>
                        <p>é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>
                        <p>è¯·æ£€æŸ¥è®¾ç½®é¡¹æ˜¯å¦å¡«å†™æ­£ç¡®ï¼Œç‚¹å‡»ã€Œåˆ·æ–°é¢„è§ˆã€é‡è¯•</p>
                    </div>
                `;
                console.error('ç­”é¢˜å¡ç”Ÿæˆé”™è¯¯ï¼š', error);
            }
        }

        function switchAnswerSheetView(view) {
            const views = ['answer-sheet', 'scratch-paper'];
            views.forEach(v => {
                const tab = document.getElementById(`as-tab-${v}`);
                const module = document.getElementById(`as-module-${v}`);
                if (tab) {
                    tab.classList.toggle('active', v === view);
                }
                if (module) {
                    module.classList.toggle('hidden', v !== view);
                    module.classList.toggle('block', v === view);
                }
            });
        }

        function generateScratchPaper() {
            try {
                const container = document.getElementById('scratchPaperContainer');
                let moduleCount = parseInt(document.getElementById('scratchPaperModules').value) || 2;
                
                if (moduleCount < 1) moduleCount = 1;
                if (moduleCount > 20) moduleCount = 20;
                
                const title = document.getElementById('scratchPaperTitle').value.trim() || 'æ‰“è‰çº¸';
                
                let gridColumns, gridRows;
                if (moduleCount === 1) {
                    gridColumns = 1;
                    gridRows = 1;
                } else if (moduleCount === 2) {
                    gridColumns = 1;
                    gridRows = 2;
                } else if (moduleCount <= 4) {
                    gridColumns = 2;
                    gridRows = 2;
                } else if (moduleCount <= 6) {
                    gridColumns = 2;
                    gridRows = 3;
                } else if (moduleCount <= 9) {
                    gridColumns = 3;
                    gridRows = 3;
                } else if (moduleCount <= 12) {
                    gridColumns = 3;
                    gridRows = 4;
                } else if (moduleCount <= 16) {
                    gridColumns = 4;
                    gridRows = 4;
                } else {
                    gridColumns = 4;
                    gridRows = 5;
                }
                
                // è®¡ç®—æ¯ä¸ªæ¨¡å—çš„é«˜åº¦ï¼Œç¡®ä¿å æ»¡æ•´å¼ çº¸
                const headerHeight = 35; // æ ‡é¢˜åŒºåŸŸé«˜åº¦(px)
                const availableHeight = 960; // A4çº¸å¯ç”¨é«˜åº¦çº¦960px (297mm - è¾¹è·)
                const moduleHeight = Math.floor((availableHeight - headerHeight) / gridRows);
                
                let html = '<div class="answer-sheet" style="font-family: \"SimSun\", \"Microsoft YaHei\", sans-serif; color: #000; height: 100%; display: flex; flex-direction: column; overflow: hidden;">';
                
                html += `
                    <div class="scratch-paper-header" style="text-align: center; padding: 5px 0; border-bottom: 1px solid #000; margin-bottom: 5px; flex-shrink: 0; height: ${headerHeight}px; box-sizing: border-box;">
                        <div class="scratch-paper-title" style="font-size: 14px; font-weight: bold; font-family: \"SimHei\", sans-serif; line-height: 1.2;">${escapeHTML(title)}</div>
                    </div>
                `;
                
                html += `<div class="scratch-paper-modules" style="display: grid; gap: 0; width: 100%; flex: 1; grid-template-columns: repeat(${gridColumns}, 1fr); grid-auto-rows: ${moduleHeight}px;">`;
                
                for (let i = 1; i <= moduleCount; i++) {
                    html += `
                        <div class="scratch-paper-module" style="border: 1px dashed #999; padding: 3px; box-sizing: border-box; display: flex; flex-direction: column; height: ${moduleHeight}px;">
                            <div class="scratch-paper-module-label" style="font-size: 9px; color: #999; text-align: center; margin-bottom: 2px; font-family: \"SimSun\", sans-serif; flex-shrink: 0;">æ¨¡å— ${i}</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
                
                container.style.padding = '3mm';
                container.style.height = '297mm';
                container.style.boxSizing = 'border-box';
                container.innerHTML = html;
                showNotification('æ‰“è‰çº¸å·²ç”Ÿæˆ', 'success');
                
            } catch (error) {
                const container = document.getElementById('scratchPaperContainer');
                container.innerHTML = `
                    <div style="text-align:center; padding:50px 0; color:#dc3545;">
                        <h3>ç”Ÿæˆæ‰“è‰çº¸å‡ºé”™äº†</h3>
                        <p>é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>
                        <p>è¯·æ£€æŸ¥è®¾ç½®é¡¹æ˜¯å¦å¡«å†™æ­£ç¡®ï¼Œç‚¹å‡»ã€Œç”Ÿæˆæ‰“è‰çº¸ã€é‡è¯•</p>
                    </div>
                `;
                console.error('æ‰“è‰çº¸ç”Ÿæˆé”™è¯¯ï¼š', error);
            }
        }

        function printAnswerSheet() {
            const content = document.getElementById('answerSheetContainer');
            if (!content.innerHTML.includes('ç‚¹å‡»')) {
                window.print();
            } else {
                showNotification('è¯·å…ˆç”Ÿæˆç­”é¢˜å¡å†æ‰“å°', 'warning');
            }
        }

        function printScratchPaper() {
            const content = document.getElementById('scratchPaperContainer');
            if (!content.innerHTML.includes('ç‚¹å‡»')) {
                window.print();
            } else {
                showNotification('è¯·å…ˆç”Ÿæˆæ‰“è‰çº¸å†æ‰“å°', 'warning');
            }
        }

        function exportAnswerSheetToPDF() {
            const content = document.getElementById('answerSheetContainer');
            if (content.innerHTML.includes('ç‚¹å‡»')) {
                showNotification('è¯·å…ˆç”Ÿæˆç­”é¢˜å¡å†å¯¼å‡º', 'warning');
                return;
            }
            
            const originalMargin = content.style.margin;
            const originalTransform = content.style.transform;
            content.style.margin = '0';
            content.style.transform = 'none';
            
            const opt = {
                margin: 0,
                filename: `ç­”é¢˜å¡_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(content).save().then(() => {
                content.style.margin = originalMargin;
                content.style.transform = originalTransform;
                showNotification('ç­”é¢˜å¡å·²å¯¼å‡ºPDF', 'success');
            });
        }

        function exportScratchPaperToPDF() {
            const content = document.getElementById('scratchPaperContainer');
            if (content.innerHTML.includes('ç‚¹å‡»')) {
                showNotification('è¯·å…ˆç”Ÿæˆæ‰“è‰çº¸å†å¯¼å‡º', 'warning');
                return;
            }
            
            const originalMargin = content.style.margin;
            const originalTransform = content.style.transform;
            content.style.margin = '0';
            content.style.transform = 'none';
            
            const opt = {
                margin: 0,
                filename: `æ‰“è‰çº¸_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(content).save().then(() => {
                content.style.margin = originalMargin;
                content.style.transform = originalTransform;
                showNotification('æ‰“è‰çº¸å·²å¯¼å‡ºPDF', 'success');
            });
        }

        // ========== ç•ªèŒ„æ—¶é’Ÿ ==========
        let tomatoCountdownTime = 1500;
        let tomatoTimerInterval = null;
        let tomatoIsRunning = false;
        let tomatoCount = 0;

        function saveTomatoStats() {
            saveToStorage(CONFIG.STORAGE_KEYS.TOMATO, { count: tomatoCount });
        }

        function loadTomatoStats() {
            const stats = loadFromStorage(CONFIG.STORAGE_KEYS.TOMATO);
            if (stats) {
                tomatoCount = stats.count || 0;
            }
        }

        function initTomato() {
            loadTomatoStats();
            
            const tomatoCurrentTimeEl = document.getElementById('tomatoCurrentTime');
            const tomatoTimerDisplayEl = document.getElementById('tomatoTimerDisplay');
            const tomatoModeBtns = document.querySelectorAll('.tomato-mode-btn');
            const tomatoStartBtn = document.getElementById('tomatoStartBtn');
            const tomatoResetBtn = document.getElementById('tomatoResetBtn');
            const tomatoCountEl = document.getElementById('tomatoCount');
            
            if (tomatoCountEl) {
                tomatoCountEl.textContent = tomatoCount;
            }

            function updateTomatoCurrentTime() {
                if (!tomatoCurrentTimeEl) return;
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                tomatoCurrentTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
            }

            function formatTomatoTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function updateTomatoTimerDisplay() {
                if (tomatoTimerDisplayEl) {
                    tomatoTimerDisplayEl.textContent = formatTomatoTime(tomatoCountdownTime);
                }
            }

            tomatoModeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (tomatoIsRunning) {
                        clearInterval(tomatoTimerInterval);
                        tomatoIsRunning = false;
                        if (tomatoStartBtn) tomatoStartBtn.textContent = 'å¼€å§‹';
                    }
                    tomatoModeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    tomatoCountdownTime = parseInt(btn.dataset.time) || 1500;
                    updateTomatoTimerDisplay();
                });
            });

            if (tomatoStartBtn) {
                tomatoStartBtn.addEventListener('click', () => {
                    if (tomatoIsRunning) {
                        clearInterval(tomatoTimerInterval);
                        tomatoIsRunning = false;
                        tomatoStartBtn.textContent = 'å¼€å§‹';
                    } else {
                        tomatoIsRunning = true;
                        tomatoStartBtn.textContent = 'æš‚åœ';
                        tomatoTimerInterval = setInterval(() => {
                            tomatoCountdownTime--;
                            updateTomatoTimerDisplay();
                            if (tomatoCountdownTime <= 0) {
                                clearInterval(tomatoTimerInterval);
                                tomatoIsRunning = false;
                                tomatoStartBtn.textContent = 'å¼€å§‹';
                                const activeMode = document.querySelector('.tomato-mode-btn.active');
                                if (activeMode && activeMode.dataset.time === '1500') {
                                    tomatoCount++;
                                    if (tomatoCountEl) {
                                        tomatoCountEl.textContent = tomatoCount;
                                    }
                                    saveTomatoStats();
                                    showNotification('æ­å–œå®Œæˆä¸€ä¸ªç•ªèŒ„é’Ÿ!', 'success');
                                }
                                try {
                                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
                                    audio.play().catch(() => {});
                                } catch (e) {
                                    console.warn('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                                }
                                if (activeMode) {
                                    tomatoCountdownTime = parseInt(activeMode.dataset.time) || 1500;
                                }
                                updateTomatoTimerDisplay();
                            }
                        }, 1000);
                    }
                });
            }

            if (tomatoResetBtn) {
                tomatoResetBtn.addEventListener('click', () => {
                    clearInterval(tomatoTimerInterval);
                    tomatoIsRunning = false;
                    if (tomatoStartBtn) tomatoStartBtn.textContent = 'å¼€å§‹';
                    const activeMode = document.querySelector('.tomato-mode-btn.active');
                    if (activeMode) {
                        tomatoCountdownTime = parseInt(activeMode.dataset.time) || 1500;
                    }
                    updateTomatoTimerDisplay();
                });
            }

            setInterval(updateTomatoCurrentTime, 1000);
            updateTomatoCurrentTime();
            updateTomatoTimerDisplay();
        }

        // ========== è¯¾è¡¨ç¨‹åº ==========
        const scheduleColors = [
            '#007aff', '#ff2d55', '#5856d6', '#34c759',
            '#ff9500', '#00c7be', '#af52de', '#ff3b30'
        ];
        let scheduleData = {};
        let scheduleTimeSlots = [
            '08:00-08:45', '08:55-09:40', '10:00-10:45', '10:55-11:40',
            '14:00-14:45', '14:55-15:40', '16:00-16:45', '16:55-17:40',
            '19:00-19:45', '19:55-20:40'
        ];
        let scheduleCurrentCell = null;
        let scheduleCurrentCourseId = null;
        let scheduleSelectedColor = scheduleColors[0];
        let scheduleCurrentWeekOffset = 0;
        let scheduleWeekStartDate = null;
        const scheduleDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];



        function calculateWeekDates() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            scheduleWeekStartDate = new Date(today);
            scheduleWeekStartDate.setDate(today.getDate() + mondayOffset + (scheduleCurrentWeekOffset * 7));
            updateWeekDisplay();
        }

        function updateWeekDisplay() {
            const endDate = new Date(scheduleWeekStartDate);
            endDate.setDate(scheduleWeekStartDate.getDate() + 6);
            const startStr = formatScheduleDate(scheduleWeekStartDate);
            const endStr = formatScheduleDate(endDate);
            document.getElementById('weekDisplay').textContent = `${startStr} è‡³ ${endStr}`;
            for (let i = 0; i < 7; i++) {
                const date = new Date(scheduleWeekStartDate);
                date.setDate(scheduleWeekStartDate.getDate() + i);
                document.getElementById(`date-${i}`).textContent = formatShortScheduleDate(date);
            }
        }

        function formatScheduleDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        function formatShortScheduleDate(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        function changeWeek(offset) {
            scheduleCurrentWeekOffset += offset;
            calculateWeekDates();
            renderScheduleTable();
        }

        function goToThisWeek() {
            scheduleCurrentWeekOffset = 0;
            calculateWeekDates();
            renderScheduleTable();
        }

        function getScheduleWeekKey() {
            const year = scheduleWeekStartDate.getFullYear();
            const month = String(scheduleWeekStartDate.getMonth() + 1).padStart(2, '0');
            const day = String(scheduleWeekStartDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getCurrentWeekSchedule() {
            const weekKey = getScheduleWeekKey();
            if (!scheduleData[weekKey]) {
                scheduleData[weekKey] = {};
            }
            return scheduleData[weekKey];
        }

        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const currentSchedule = getCurrentWeekSchedule();
            scheduleTimeSlots.forEach((time, timeIndex) => {
                const tr = document.createElement('tr');
                const timeTd = document.createElement('td');
                timeTd.className = 'schedule-time-column';
                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.className = 'schedule-time-input';
                timeInput.value = time;
                timeInput.dataset.index = timeIndex;
                timeInput.onchange = (e) => updateScheduleTimeSlot(timeIndex, e.target.value);
                timeTd.appendChild(timeInput);
                tr.appendChild(timeTd);
                scheduleDays.forEach((day, dayIndex) => {
                    const td = document.createElement('td');
                    td.dataset.day = dayIndex;
                    td.dataset.time = timeIndex;
                    td.onclick = () => openScheduleModal(dayIndex, timeIndex);
                    const courseId = `${dayIndex}-${timeIndex}`;
                    if (currentSchedule[courseId]) {
                        const course = currentSchedule[courseId];
                        const courseCard = document.createElement('div');
                        courseCard.className = 'schedule-course-card';
                        courseCard.style.backgroundColor = course.color;
                        courseCard.onclick = (e) => {
                            e.stopPropagation();
                            openScheduleModal(dayIndex, timeIndex, courseId);
                        };
                        courseCard.innerHTML = `
                            <div class="schedule-course-name">${course.name}</div>
                            <div class="schedule-course-location">${course.location}</div>
                        `;
                        td.appendChild(courseCard);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function updateScheduleTimeSlot(index, value) {
            scheduleTimeSlots[index] = value;
            saveScheduleData();
        }

        function renderScheduleColorPicker() {
            const colorPicker = document.getElementById('colorPicker');
            colorPicker.innerHTML = '';
            scheduleColors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.className = 'schedule-color-option' + (index === 0 ? ' selected' : '');
                colorOption.style.backgroundColor = color;
                colorOption.onclick = () => selectScheduleColor(color, colorOption);
                colorPicker.appendChild(colorOption);
            });
        }

        function selectScheduleColor(color, element) {
            scheduleSelectedColor = color;
            document.querySelectorAll('.schedule-color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function openScheduleModal(dayIndex, timeIndex, courseId = null) {
            scheduleCurrentCell = { day: dayIndex, time: timeIndex };
            scheduleCurrentCourseId = courseId;
            const currentSchedule = getCurrentWeekSchedule();
            const modalTitle = document.getElementById('modalTitle');
            const deleteButtonContainer = document.getElementById('deleteButtonContainer');
            if (courseId && currentSchedule[courseId]) {
                const course = currentSchedule[courseId];
                modalTitle.textContent = 'ç¼–è¾‘è¯¾ç¨‹';
                document.getElementById('courseName').value = course.name;
                document.getElementById('courseLocation').value = course.location;
                document.getElementById('courseTeacher').value = course.teacher;
                scheduleSelectedColor = course.color;
                deleteButtonContainer.style.display = 'flex';
                document.querySelectorAll('.schedule-color-option').forEach(el => {
                    el.classList.toggle('selected', el.style.backgroundColor === course.color);
                });
            } else {
                modalTitle.textContent = 'æ·»åŠ è¯¾ç¨‹';
                document.getElementById('courseName').value = '';
                document.getElementById('courseLocation').value = '';
                document.getElementById('courseTeacher').value = '';
                scheduleSelectedColor = scheduleColors[0];
                deleteButtonContainer.style.display = 'none';
                document.querySelectorAll('.schedule-color-option').forEach((el, index) => {
                    el.classList.toggle('selected', index === 0);
                });
            }
            document.getElementById('courseModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('courseModal').classList.remove('show');
            scheduleCurrentCell = null;
            scheduleCurrentCourseId = null;
        }

        function saveCourse() {
            const name = document.getElementById('courseName').value.trim();
            const location = document.getElementById('courseLocation').value.trim();
            const teacher = document.getElementById('courseTeacher').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥è¯¾ç¨‹åç§°');
                return;
            }
            const weekKey = getScheduleWeekKey();
            const courseId = `${scheduleCurrentCell.day}-${scheduleCurrentCell.time}`;
            if (!scheduleData[weekKey]) {
                scheduleData[weekKey] = {};
            }
            scheduleData[weekKey][courseId] = {
                name,
                location,
                teacher,
                color: scheduleSelectedColor,
                day: scheduleCurrentCell.day,
                time: scheduleCurrentCell.time
            };
            saveScheduleData();
            renderScheduleTable();
            closeModal();
        }

        function deleteCourse() {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é—¨è¯¾ç¨‹å—ï¼Ÿ')) {
                const weekKey = getScheduleWeekKey();
                delete scheduleData[weekKey][scheduleCurrentCourseId];
                saveScheduleData();
                renderScheduleTable();
                closeModal();
            }
        }

        function saveScheduleData() {
            const data = {
                schedule: scheduleData,
                timeSlots: scheduleTimeSlots
            };
            localStorage.setItem('scheduleData', JSON.stringify(data));
        }

        function loadScheduleData() {
            const saved = localStorage.getItem('scheduleData');
            if (saved) {
                const data = JSON.parse(saved);
                scheduleData = data.schedule || {};
                scheduleTimeSlots = data.timeSlots || scheduleTimeSlots;
            }
        }

        function clearAllCourses() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæœ¬å‘¨æ‰€æœ‰è¯¾ç¨‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                const weekKey = getScheduleWeekKey();
                scheduleData[weekKey] = {};
                saveScheduleData();
                renderScheduleTable();
            }
        }

        function addScheduleRow() {
            const newTime = prompt('è¯·è¾“å…¥æ–°çš„æ—¶é—´æ®µï¼ˆä¾‹å¦‚ï¼š21:00-21:45ï¼‰ï¼š');
            if (newTime && newTime.trim()) {
                scheduleTimeSlots.push(newTime.trim());
                renderScheduleTable();
                showNotification('å·²æ·»åŠ æ–°è¡Œ', 'success');
            }
        }

        function deleteScheduleRow() {
            if (scheduleTimeSlots.length === 0) {
                showNotification('æ²¡æœ‰å¯åˆ é™¤çš„è¡Œ', 'warning');
                return;
            }
            
            const index = prompt(`è¯·è¾“å…¥è¦åˆ é™¤çš„è¡Œå·ï¼ˆ1-${scheduleTimeSlots.length}ï¼‰ï¼š`);
            const rowIndex = parseInt(index) - 1;
            
            if (isNaN(rowIndex) || rowIndex < 0 || rowIndex >= scheduleTimeSlots.length) {
                showNotification('æ— æ•ˆçš„è¡Œå·', 'warning');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${index} è¡Œï¼ˆ${scheduleTimeSlots[rowIndex]}ï¼‰å—ï¼Ÿè¯¥è¡Œçš„è¯¾ç¨‹æ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ã€‚`)) {
                // åˆ é™¤è¯¥æ—¶é—´æ®µçš„è¯¾ç¨‹æ•°æ®
                const weekKey = getScheduleWeekKey();
                if (scheduleData[weekKey]) {
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const courseId = `${dayIndex}-${rowIndex}`;
                        delete scheduleData[weekKey][courseId];
                    }
                    // é‡æ–°è°ƒæ•´å…¶ä»–è¡Œçš„ç´¢å¼•
                    const newData = {};
                    Object.keys(scheduleData[weekKey]).forEach(key => {
                        const [day, timeIdx] = key.split('-').map(Number);
                        if (timeIdx > rowIndex) {
                            newData[`${day}-${timeIdx - 1}`] = scheduleData[weekKey][key];
                        } else if (timeIdx < rowIndex) {
                            newData[key] = scheduleData[weekKey][key];
                        }
                    });
                    scheduleData[weekKey] = newData;
                    saveScheduleData();
                }
                
                scheduleTimeSlots.splice(rowIndex, 1);
                renderScheduleTable();
                showNotification('å·²åˆ é™¤è¯¥è¡Œ', 'success');
            }
        }

        function resetSchedule() {
            if (confirm('ç¡®å®šè¦é‡ç½®è¯¾ç¨‹è¡¨å—ï¼Ÿè¿™å°†æ¢å¤é»˜è®¤çš„æ—¶é—´æ®µè®¾ç½®ï¼Œä½†ä¼šä¿ç•™è¯¾ç¨‹æ•°æ®ã€‚')) {
                scheduleTimeSlots = [
                    '08:00-08:45', '08:55-09:40', '10:00-10:45', '10:55-11:40',
                    '14:00-14:45', '14:55-15:40', '16:00-16:45', '16:55-17:40',
                    '19:00-19:45', '19:55-20:40'
                ];
                renderScheduleTable();
                showNotification('è¯¾ç¨‹è¡¨å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
            }
        }

        function exportToPDF() {
            const element = document.getElementById('scheduleContainer');
            
            // ä¸´æ—¶ä¿®æ”¹æ ·å¼ä»¥ä¼˜åŒ–PDFè¾“å‡º
            const originalPadding = element.style.padding;
            const originalMargin = element.style.margin;
            element.style.padding = '5px';
            element.style.margin = '0';
            
            const opt = {
                margin: [5, 5, 5, 5],
                filename: `è¯¾è¡¨_${getScheduleWeekKey()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'landscape'
                },
                pagebreak: {
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.page-break-before',
                    after: '.page-break-after',
                    avoid: 'tr'
                }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // æ¢å¤åŸå§‹æ ·å¼
                element.style.padding = originalPadding;
                element.style.margin = originalMargin;
                showNotification('è¯¾è¡¨å·²å¯¼å‡ºPDF', 'success');
            });
        }

        function exportToExcel() {
            const currentSchedule = getCurrentWeekSchedule();
            const weekKey = getScheduleWeekKey();
            const data = [];
            const headers = ['æ—¶é—´'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(scheduleWeekStartDate);
                date.setDate(scheduleWeekStartDate.getDate() + i);
                headers.push(`${scheduleDays[i]} ${formatShortScheduleDate(date)}`);
            }
            data.push(headers);
            scheduleTimeSlots.forEach((time, timeIndex) => {
                const row = [time];
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const courseId = `${dayIndex}-${timeIndex}`;
                    if (currentSchedule[courseId]) {
                        const course = currentSchedule[courseId];
                        row.push(`${course.name} | ${course.location} | ${course.teacher}`);
                    } else {
                        row.push('');
                    }
                }
                data.push(row);
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è¯¾è¡¨');
            XLSX.writeFile(wb, `è¯¾è¡¨_${weekKey}.xlsx`);
        }

        // ========== æœˆè®¡åˆ’ ==========
        let monthPlans = {};
        let currentMonthDate = new Date();
        let currentSelectedDate = null;
        let editingMonthPlanId = null;
        let monthPlanSelectedColor = scheduleColors[0];
        const MONTH_PLAN_STORAGE = 'monthPlansData';

        function initSchedule() {
            loadScheduleData();
            loadMonthPlans();
            calculateWeekDates();
            renderScheduleTable();
            renderScheduleColorPicker();
            renderMonthCalendar();
            updateMonthDisplay();
        }

        function switchScheduleView(view) {
            const views = ['week', 'month'];
            views.forEach(v => {
                const tab = document.getElementById(`schedule-tab-${v}`);
                const module = document.getElementById(`schedule-module-${v}`);
                if (tab) {
                    tab.classList.toggle('active', v === view);
                }
                if (module) {
                    module.classList.toggle('hidden', v !== view);
                }
            });
            
            if (view === 'month') {
                renderMonthCalendar();
            }
        }

        function getDayKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDayDisplay(date) {
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const d = new Date(date);
            return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ ${days[d.getDay()]}`;
        }

        function formatMonthDisplay(date) {
            const d = new Date(date);
            return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
        }

        function changeMonth(offset) {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + offset);
            updateMonthDisplay();
            renderMonthCalendar();
        }

        function goToThisMonth() {
            currentMonthDate = new Date();
            updateMonthDisplay();
            renderMonthCalendar();
        }

        function updateMonthDisplay() {
            const display = document.getElementById('monthDisplay');
            if (display) {
                display.textContent = formatMonthDisplay(currentMonthDate);
            }
        }

        function loadMonthPlans() {
            const saved = loadFromStorage(MONTH_PLAN_STORAGE, {});
            monthPlans = saved;
        }

        function saveMonthPlans() {
            saveToStorage(MONTH_PLAN_STORAGE, monthPlans);
        }

        function getMonthPlansForDate(dateKey) {
            return monthPlans[dateKey] || [];
        }

        function renderMonthCalendar() {
            const container = document.getElementById('monthCalendar');
            if (!container) return;

            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            const todayKey = getDayKey(today);
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            let html = '';
            
            weekDays.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });

            const prevMonth = new Date(year, month, 0);
            const prevDays = prevMonth.getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevDays - i;
                const date = new Date(year, month - 1, day);
                const dateKey = getDayKey(date);
                const plans = getMonthPlansForDate(dateKey);
                html += renderCalendarDay(day, dateKey, plans, true);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = getDayKey(date);
                const isToday = dateKey === todayKey;
                const plans = getMonthPlansForDate(dateKey);
                html += renderCalendarDay(day, dateKey, plans, false, isToday);
            }

            const totalCells = startDay + daysInMonth;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dateKey = getDayKey(date);
                const plans = getMonthPlansForDate(dateKey);
                html += renderCalendarDay(day, dateKey, plans, true);
            }

            container.innerHTML = html;
        }

        function renderCalendarDay(day, dateKey, plans, isOtherMonth, isToday = false) {
            const dots = plans.slice(0, 3).map(p => 
                `<div class="calendar-dot" style="background-color: ${p.color};"></div>`
            ).join('');
            
            let classes = 'calendar-day';
            if (isOtherMonth) classes += ' other-month';
            if (isToday) classes += ' today';
            
            return `
                <div class="${classes}" onclick="selectCalendarDay('${dateKey}')">
                    <div class="calendar-day-number">${day}</div>
                    ${dots ? `<div class="calendar-dots">${dots}</div>` : ''}
                </div>
            `;
        }

        function selectCalendarDay(dateKey) {
            currentSelectedDate = dateKey;
            const [year, month, day] = dateKey.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            document.getElementById('selectedDateTitle').textContent = `${year}å¹´${month}æœˆ${day}æ—¥ ${days[d.getDay()]}`;
            
            document.getElementById('monthPlanDetail').style.display = 'block';
            renderMonthPlanList(dateKey);
            
            // ç§»é™¤å…¶ä»–æ—¥æœŸçš„é€‰ä¸­æ ·å¼
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.remove('selected');
                el.style.borderColor = 'transparent';
            });
            
            // æ·»åŠ å½“å‰é€‰ä¸­æ ·å¼
            const calendarDays = document.querySelectorAll('.calendar-day');
            calendarDays.forEach(el => {
                if (el.getAttribute('onclick') && el.getAttribute('onclick').includes(dateKey)) {
                    el.classList.add('selected');
                    el.style.borderColor = 'var(--primary-color)';
                }
            });
        }

        function renderMonthPlanList(dateKey) {
            const container = document.getElementById('monthPlanList');
            const plans = getMonthPlansForDate(dateKey);
            
            if (plans.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-10">
                        <i class="fa fa-calendar-check-o text-4xl mb-4"></i>
                        <p>æš‚æ— è®¡åˆ’ï¼Œç‚¹å‡»ã€Œæ·»åŠ è®¡åˆ’ã€å¼€å§‹å®‰æ’</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = plans.map(plan => `
                <div class="day-plan-item" data-id="${plan.id}" style="border-left-color: ${plan.color};">
                    <div class="day-plan-content" style="flex: 1;">
                        <div class="day-plan-title" style="color: ${plan.color};">${escapeHTML(plan.title)}</div>
                        ${plan.content ? `<div class="day-plan-desc">${escapeHTML(plan.content)}</div>` : ''}
                    </div>
                    <div class="day-plan-actions">
                        <button class="day-plan-action-btn edit" onclick="editMonthPlan('${dateKey}', '${plan.id}')" title="ç¼–è¾‘">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="day-plan-action-btn delete" onclick="deleteMonthPlanById('${plan.id}')" title="åˆ é™¤">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openMonthPlanModal(dateKey = null) {
            editingMonthPlanId = null;
            document.getElementById('monthPlanModalTitle').textContent = 'æ·»åŠ æœˆè®¡åˆ’';
            document.getElementById('monthPlanTitle').value = '';
            document.getElementById('monthPlanContent').value = '';
            document.getElementById('monthPlanDate').value = dateKey || getDayKey(new Date());
            document.getElementById('monthPlanDeleteContainer').style.display = 'none';
            monthPlanSelectedColor = scheduleColors[0];
            renderMonthPlanColorPicker();
            document.getElementById('monthPlanModal').classList.add('show');
        }

        function closeMonthPlanModal() {
            document.getElementById('monthPlanModal').classList.remove('show');
            editingMonthPlanId = null;
        }

        function editMonthPlan(dateKey, id) {
            const plans = monthPlans[dateKey] || [];
            const plan = plans.find(p => p.id === id);
            
            if (!plan) return;
            
            editingMonthPlanId = id;
            document.getElementById('monthPlanModalTitle').textContent = 'ç¼–è¾‘æœˆè®¡åˆ’';
            document.getElementById('monthPlanTitle').value = plan.title;
            document.getElementById('monthPlanContent').value = plan.content || '';
            document.getElementById('monthPlanDate').value = dateKey;
            document.getElementById('monthPlanDeleteContainer').style.display = 'flex';
            monthPlanSelectedColor = plan.color;
            renderMonthPlanColorPicker();
            document.getElementById('monthPlanModal').classList.add('show');
        }

        function saveMonthPlan() {
            const title = document.getElementById('monthPlanTitle').value.trim();
            const content = document.getElementById('monthPlanContent').value.trim();
            const dateKey = document.getElementById('monthPlanDate').value;
            
            if (!title) {
                showNotification('è¯·è¾“å…¥è®¡åˆ’æ ‡é¢˜', 'warning');
                return;
            }
            
            if (!monthPlans[dateKey]) {
                monthPlans[dateKey] = [];
            }
            
            if (editingMonthPlanId) {
                const index = monthPlans[dateKey].findIndex(p => p.id === editingMonthPlanId);
                if (index !== -1) {
                    monthPlans[dateKey][index] = {
                        ...monthPlans[dateKey][index],
                        title,
                        content,
                        color: monthPlanSelectedColor
                    };
                }
                showNotification('è®¡åˆ’å·²æ›´æ–°', 'success');
            } else {
                monthPlans[dateKey].push({
                    id: Date.now().toString(),
                    title,
                    content,
                    color: monthPlanSelectedColor,
                    createdAt: new Date().toISOString()
                });
                showNotification('è®¡åˆ’å·²æ·»åŠ ', 'success');
            }
            
            saveMonthPlans();
            renderMonthCalendar();
            if (currentSelectedDate) {
                renderMonthPlanList(currentSelectedDate);
            }
            closeMonthPlanModal();
        }

        function deleteMonthPlan() {
            if (!editingMonthPlanId) return;
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¡åˆ’å—ï¼Ÿ')) {
                deleteMonthPlanById(editingMonthPlanId);
                closeMonthPlanModal();
            }
        }

        function deleteMonthPlanById(id) {
            Object.keys(monthPlans).forEach(dateKey => {
                monthPlans[dateKey] = monthPlans[dateKey].filter(p => p.id !== id);
                if (monthPlans[dateKey].length === 0) {
                    delete monthPlans[dateKey];
                }
            });
            saveMonthPlans();
            renderMonthCalendar();
            if (currentSelectedDate) {
                renderMonthPlanList(currentSelectedDate);
            }
            showNotification('è®¡åˆ’å·²åˆ é™¤', 'success');
        }

        function renderMonthPlanColorPicker() {
            const colorPicker = document.getElementById('monthPlanColorPicker');
            if (!colorPicker) return;
            
            colorPicker.innerHTML = '';
            scheduleColors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.className = 'schedule-color-option' + (color === monthPlanSelectedColor ? ' selected' : '');
                colorOption.style.backgroundColor = color;
                colorOption.onclick = () => {
                    monthPlanSelectedColor = color;
                    renderMonthPlanColorPicker();
                };
                colorPicker.appendChild(colorOption);
            });
        }

        function exportMonthPlanToPDF() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const allPlans = [];
            Object.keys(monthPlans).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    monthPlans[dateKey].forEach(plan => {
                        allPlans.push({
                            date: dateKey,
                            ...plan
                        });
                    });
                }
            });
            
            if (allPlans.length === 0) {
                showNotification('æœ¬æœˆæš‚æ— è®¡åˆ’å¯å¯¼å‡º', 'warning');
                return;
            }
            
            const container = document.createElement('div');
            container.style.cssText = 'padding: 40px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: white;';
            
            allPlans.sort((a, b) => a.date.localeCompare(b.date));
            
            const groupedPlans = {};
            allPlans.forEach(plan => {
                if (!groupedPlans[plan.date]) {
                    groupedPlans[plan.date] = [];
                }
                groupedPlans[plan.date].push(plan);
            });
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0071e3; padding-bottom: 20px;">
                    <h1 style="color: #1d1d1f; margin: 0; font-size: 28px;">æœˆè®¡åˆ’</h1>
                    <p style="color: #86868b; margin: 10px 0 0; font-size: 18px;">${formatMonthDisplay(currentMonthDate)}</p>
                </div>
                <div style="margin-top: 20px;">
                    ${Object.keys(groupedPlans).sort().map(dateKey => {
                        const [y, m, d] = dateKey.split('-').map(Number);
                        const date = new Date(y, m - 1, d);
                        const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                        return `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #0071e3; font-size: 18px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e5e5e7;">
                                    ğŸ“… ${m}æœˆ${d}æ—¥ ${days[date.getDay()]}
                                </h3>
                                ${groupedPlans[dateKey].map((plan, index) => `
                                    <div style="margin-bottom: 12px; padding: 12px; border-left: 4px solid ${plan.color}; background: #f5f5f7; border-radius: 8px; margin-left: 10px;">
                                        <div style="font-weight: 600; font-size: 15px; color: ${plan.color}; margin-bottom: 6px;">
                                            ${index + 1}. ${escapeHTML(plan.title)}
                                        </div>
                                        ${plan.content ? `<div style="color: #555; font-size: 14px; line-height: 1.5;">${escapeHTML(plan.content)}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e5e7; text-align: center; color: #86868b; font-size: 12px;">
                    ç‹¬ç«‹æ•°å­¦è€å¸ˆè¾…åŠ©å·¥å…· - æœˆè®¡åˆ’å¯¼å‡º
                </div>
            `;
            
            const opt = {
                margin: 10,
                filename: `æœˆè®¡åˆ’_${monthKey}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            document.body.appendChild(container);
            html2pdf().set(opt).from(container).save().then(() => {
                document.body.removeChild(container);
                showNotification('æœˆè®¡åˆ’å·²å¯¼å‡ºPDF', 'success');
            });
        }

        function exportMonthPlanToExcel() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const allPlans = [];
            Object.keys(monthPlans).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    monthPlans[dateKey].forEach(plan => {
                        allPlans.push({
                            date: dateKey,
                            ...plan
                        });
                    });
                }
            });
            
            if (allPlans.length === 0) {
                showNotification('æœ¬æœˆæš‚æ— è®¡åˆ’å¯å¯¼å‡º', 'warning');
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åº
            allPlans.sort((a, b) => a.date.localeCompare(b.date));
            
            // å‡†å¤‡Excelæ•°æ®
            const data = [];
            const headers = ['æ—¥æœŸ', 'æ˜ŸæœŸ', 'è®¡åˆ’æ ‡é¢˜', 'è®¡åˆ’å†…å®¹', 'åˆ›å»ºæ—¶é—´'];
            data.push(headers);
            
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            
            allPlans.forEach(plan => {
                const [y, m, d] = plan.date.split('-').map(Number);
                const date = new Date(y, m - 1, d);
                const dayOfWeek = days[date.getDay()];
                const createdAt = plan.createdAt ? new Date(plan.createdAt).toLocaleString('zh-CN') : '';
                
                data.push([
                    plan.date,
                    dayOfWeek,
                    plan.title,
                    plan.content || '',
                    createdAt
                ]);
            });
            
            // åˆ›å»ºExcelå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 12 },  // æ—¥æœŸ
                { wch: 8 },   // æ˜ŸæœŸ
                { wch: 30 },  // è®¡åˆ’æ ‡é¢˜
                { wch: 50 },  // è®¡åˆ’å†…å®¹
                { wch: 20 }   // åˆ›å»ºæ—¶é—´
            ];
            
            // åˆ›å»ºå·¥ä½œç°¿å¹¶å¯¼å‡º
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æœˆè®¡åˆ’');
            XLSX.writeFile(wb, `æœˆè®¡åˆ’_${monthKey}.xlsx`);
            
            showNotification('æœˆè®¡åˆ’å·²å¯¼å‡ºExcel', 'success');
        }

        // ========== å‡ ä½•ç»˜å›¾ç¨‹åº ==========
        let geometryCanvas = null;
        let geometryCtx = null;
        let geometryShapes = [];
        let geometryHistory = [];
        let geometryCurrentTool = 'select';
        let geometryCurrentColor = '#0071e3';
        let geometryCurrentFill = 'transparent';
        let geometryCurrentLineWidth = 2;
        let geometryIsDrawing = false;
        let geometryStartPoint = null;
        let geometryTempShape = null;
        let geometryShowGrid = true;
        let geometrySelectedShape = null;

        function initGeometryDrawing() {
            geometryCanvas = document.getElementById('geometry-canvas');
            if (!geometryCanvas) return;
            
            geometryCtx = geometryCanvas.getContext('2d');
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
            setTimeout(() => {
                resizeGeometryCanvas();
                redrawGeometryCanvas();
            }, 100);
            
            // ç»‘å®šå·¥å…·æŒ‰é’®
            document.querySelectorAll('.geometry-tool-btn').forEach(btn => {
                btn.addEventListener('click', () => selectGeometryTool(btn.dataset.tool));
            });
            
            // ç»‘å®šé¢œè‰²æŒ‰é’®
            document.querySelectorAll('.geometry-color-btn').forEach(btn => {
                btn.addEventListener('click', () => selectGeometryColor(btn.dataset.color));
            });
            
            // ç»‘å®šå¡«å……æŒ‰é’®
            document.querySelectorAll('.geometry-fill-btn').forEach(btn => {
                btn.addEventListener('click', () => selectGeometryFill(btn.dataset.fill));
            });
            
            // ç»‘å®šçº¿æ¡ç²—ç»†
            const lineWidthSlider = document.getElementById('geometry-line-width');
            if (lineWidthSlider) {
                lineWidthSlider.addEventListener('input', (e) => {
                    geometryCurrentLineWidth = parseInt(e.target.value);
                    document.getElementById('geometry-line-width-value').textContent = e.target.value + 'px';
                });
            }
            
            // ç»‘å®šç”»å¸ƒäº‹ä»¶
            geometryCanvas.addEventListener('mousedown', handleGeometryMouseDown);
            geometryCanvas.addEventListener('mousemove', handleGeometryMouseMove);
            geometryCanvas.addEventListener('mouseup', handleGeometryMouseUp);
            geometryCanvas.addEventListener('mouseleave', handleGeometryMouseUp);
            geometryCanvas.addEventListener('dblclick', handleGeometryDoubleClick);
            geometryCanvas.addEventListener('contextmenu', handleGeometryRightClick);
            
            // ç»‘å®šæ“ä½œæŒ‰é’®
            document.getElementById('geometry-clear')?.addEventListener('click', clearGeometryCanvas);
            document.getElementById('geometry-undo')?.addEventListener('click', undoGeometry);
            document.getElementById('geometry-export')?.addEventListener('click', exportGeometryImage);
            document.getElementById('geometry-grid-toggle')?.addEventListener('click', toggleGeometryGrid);
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´ç”»å¸ƒ
            window.addEventListener('resize', () => {
                resizeGeometryCanvas();
                redrawGeometryCanvas();
            });
        }

        function resizeGeometryCanvas() {
            if (!geometryCanvas) return;
            const rect = geometryCanvas.parentElement.getBoundingClientRect();
            geometryCanvas.width = rect.width;
            geometryCanvas.height = rect.height;
        }

        function selectGeometryTool(tool) {
            geometryCurrentTool = tool;
            document.querySelectorAll('.geometry-tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
            geometryCanvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
        }

        function selectGeometryColor(color) {
            geometryCurrentColor = color;
            document.querySelectorAll('.geometry-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.color === color);
            });
        }

        function selectGeometryFill(fill) {
            geometryCurrentFill = fill;
            document.querySelectorAll('.geometry-fill-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.fill === fill);
            });
        }

        function getGeometryMousePos(e) {
            const rect = geometryCanvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function handleGeometryMouseDown(e) {
            const pos = getGeometryMousePos(e);
            geometryStartPoint = pos;
            
            if (geometryCurrentTool === 'select') {
                // é€‰æ‹©å·¥å…·ï¼šå°è¯•é€‰ä¸­å›¾å½¢
                const clickedShapeIndex = findShapeAtPosition(pos);
                if (clickedShapeIndex !== -1) {
                    geometrySelectedShape = clickedShapeIndex;
                    geometryIsDrawing = true; // ç”¨äºæ‹–æ‹½
                    redrawGeometryCanvas();
                } else {
                    geometrySelectedShape = null;
                    redrawGeometryCanvas();
                }
                return;
            } else if (geometryCurrentTool === 'point') {
                addGeometryShape({
                    type: 'point',
                    x: pos.x,
                    y: pos.y,
                    color: geometryCurrentColor,
                    lineWidth: geometryCurrentLineWidth
                });
                geometryIsDrawing = false;
            } else if (geometryCurrentTool === 'polygon') {
                // å¤šè¾¹å½¢ç‰¹æ®Šå¤„ç†ï¼šç‚¹å‡»æ·»åŠ é¡¶ç‚¹
                if (!geometryTempShape) {
                    geometryTempShape = {
                        type: 'polygon',
                        points: [pos],
                        color: geometryCurrentColor,
                        fill: geometryCurrentFill,
                        lineWidth: geometryCurrentLineWidth
                    };
                } else {
                    geometryTempShape.points.push(pos);
                    redrawGeometryCanvas();
                }
            } else {
                // å…¶ä»–å·¥å…·ï¼šline, segment, circle, rectangle, triangle
                geometryIsDrawing = true;
            }
        }

        // æŸ¥æ‰¾ç‚¹å‡»ä½ç½®ä¸Šçš„å›¾å½¢
        function findShapeAtPosition(pos) {
            const hitRadius = 10; // ç‚¹å‡»æ£€æµ‹åŠå¾„
            
            // ä»åå‘å‰æŸ¥æ‰¾ï¼ˆå…ˆç»˜åˆ¶åœ¨ä¸Šå±‚ï¼‰
            for (let i = geometryShapes.length - 1; i >= 0; i--) {
                const shape = geometryShapes[i];
                if (isPointOnShape(pos, shape, hitRadius)) {
                    return i;
                }
            }
            return -1;
        }

        // åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å›¾å½¢ä¸Š
        function isPointOnShape(pos, shape, hitRadius) {
            switch (shape.type) {
                case 'point':
                    return Math.sqrt(Math.pow(pos.x - shape.x, 2) + Math.pow(pos.y - shape.y, 2)) <= hitRadius + shape.lineWidth;
                
                case 'line':
                case 'segment':
                    return distanceToLine(pos, shape.x1, shape.y1, shape.x2, shape.y2) <= hitRadius;
                
                case 'circle':
                    const distToCenter = Math.sqrt(Math.pow(pos.x - shape.x, 2) + Math.pow(pos.y - shape.y, 2));
                    return Math.abs(distToCenter - shape.radius) <= hitRadius || distToCenter <= hitRadius;
                
                case 'rectangle':
                    return pos.x >= shape.x - hitRadius && 
                           pos.x <= shape.x + shape.width + hitRadius &&
                           pos.y >= shape.y - hitRadius && 
                           pos.y <= shape.y + shape.height + hitRadius;
                
                case 'triangle':
                    return isPointInTriangle(pos, shape);
                
                case 'polygon':
                    return isPointInPolygon(pos, shape.points);
                
                default:
                    return false;
            }
        }

        // è®¡ç®—ç‚¹åˆ°çº¿æ®µçš„è·ç¦»
        function distanceToLine(pos, x1, y1, x2, y2) {
            const A = pos.x - x1;
            const B = pos.y - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = pos.x - xx;
            const dy = pos.y - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }

        // åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨ä¸‰è§’å½¢å†…
        function isPointInTriangle(pos, triangle) {
            const { x1, y1, x2, y2, x3, y3 } = triangle;
            const d1 = sign(pos, { x: x1, y: y1 }, { x: x2, y: y2 });
            const d2 = sign(pos, { x: x2, y: y2 }, { x: x3, y: y3 });
            const d3 = sign(pos, { x: x3, y: y3 }, { x: x1, y: y1 });
            
            const hasNeg = (d1 < 0) || (d2 < 0) || (d3 < 0);
            const hasPos = (d1 > 0) || (d2 > 0) || (d3 > 0);
            
            return !(hasNeg && hasPos);
        }

        function sign(p1, p2, p3) {
            return (p1.x - p3.x) * (p2.y - p3.y) - (p2.x - p3.x) * (p1.y - p3.y);
        }

        // åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
        function isPointInPolygon(pos, points) {
            let inside = false;
            for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                const xi = points[i].x, yi = points[i].y;
                const xj = points[j].x, yj = points[j].y;
                
                const intersect = ((yi > pos.y) !== (yj > pos.y)) &&
                    (pos.x < (xj - xi) * (pos.y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // ç§»åŠ¨å›¾å½¢
        function moveShape(shape, dx, dy) {
            switch (shape.type) {
                case 'point':
                    shape.x += dx;
                    shape.y += dy;
                    break;
                case 'line':
                case 'segment':
                    shape.x1 += dx;
                    shape.y1 += dy;
                    shape.x2 += dx;
                    shape.y2 += dy;
                    break;
                case 'circle':
                    shape.x += dx;
                    shape.y += dy;
                    break;
                case 'rectangle':
                    shape.x += dx;
                    shape.y += dy;
                    break;
                case 'triangle':
                    shape.x1 += dx;
                    shape.y1 += dy;
                    shape.x2 += dx;
                    shape.y2 += dy;
                    shape.x3 += dx;
                    shape.y3 += dy;
                    break;
                case 'polygon':
                    shape.points.forEach(p => {
                        p.x += dx;
                        p.y += dy;
                    });
                    break;
            }
        }

        function handleGeometryMouseMove(e) {
            const pos = getGeometryMousePos(e);
            
            // æ›´æ–°åæ ‡æ˜¾ç¤º
            document.getElementById('geometry-coords').textContent = `åæ ‡: (${Math.round(pos.x)}, ${Math.round(pos.y)})`;
            
            if (!geometryIsDrawing) return;
            
            if (geometryCurrentTool === 'select' && geometrySelectedShape !== null) {
                // æ‹–æ‹½ç§»åŠ¨é€‰ä¸­çš„å›¾å½¢
                const dx = pos.x - geometryStartPoint.x;
                const dy = pos.y - geometryStartPoint.y;
                
                moveShape(geometryShapes[geometrySelectedShape], dx, dy);
                
                geometryStartPoint = pos; // æ›´æ–°èµ·å§‹ç‚¹
                redrawGeometryCanvas();
                return;
            }
            
            if (geometryCurrentTool === 'line' || geometryCurrentTool === 'segment') {
                geometryTempShape = {
                    type: geometryCurrentTool,
                    x1: geometryStartPoint.x,
                    y1: geometryStartPoint.y,
                    x2: pos.x,
                    y2: pos.y,
                    color: geometryCurrentColor,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(pos.x - geometryStartPoint.x, 2) + Math.pow(pos.y - geometryStartPoint.y, 2));
                geometryTempShape = {
                    type: 'circle',
                    x: geometryStartPoint.x,
                    y: geometryStartPoint.y,
                    radius: radius,
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'rectangle') {
                geometryTempShape = {
                    type: 'rectangle',
                    x: Math.min(geometryStartPoint.x, pos.x),
                    y: Math.min(geometryStartPoint.y, pos.y),
                    width: Math.abs(pos.x - geometryStartPoint.x),
                    height: Math.abs(pos.y - geometryStartPoint.y),
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'triangle') {
                geometryTempShape = {
                    type: 'triangle',
                    x1: geometryStartPoint.x,
                    y1: geometryStartPoint.y,
                    x2: pos.x,
                    y2: geometryStartPoint.y,
                    x3: (geometryStartPoint.x + pos.x) / 2,
                    y3: pos.y,
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth
                };
            }
            
            redrawGeometryCanvas();
        }

        function handleGeometryMouseUp(e) {
            if (!geometryIsDrawing) return;
            
            geometryIsDrawing = false;
            
            if (geometryTempShape && geometryCurrentTool !== 'polygon') {
                // ç¡®ä¿å›¾å½¢æœ‰è¶³å¤Ÿçš„å¤§å°æ‰æ·»åŠ 
                if (isValidShape(geometryTempShape)) {
                    addGeometryShape(geometryTempShape);
                }
                geometryTempShape = null;
                redrawGeometryCanvas();
            }
        }

        function isValidShape(shape) {
            if (!shape) return false;
            
            switch (shape.type) {
                case 'line':
                case 'segment':
                    return Math.abs(shape.x2 - shape.x1) > 2 || Math.abs(shape.y2 - shape.y1) > 2;
                case 'circle':
                    return shape.radius > 2;
                case 'rectangle':
                    return shape.width > 2 && shape.height > 2;
                case 'triangle':
                    return Math.abs(shape.x2 - shape.x1) > 2;
                case 'polygon':
                    return shape.points.length >= 3;
                default:
                    return true;
            }
        }

        function handleGeometryDoubleClick(e) {
            e.preventDefault();
            // åŒå‡»å®Œæˆå¤šè¾¹å½¢
            if (geometryCurrentTool === 'polygon' && geometryTempShape && geometryTempShape.points.length >= 3) {
                addGeometryShape({
                    type: 'polygon',
                    points: [...geometryTempShape.points],
                    color: geometryTempShape.color,
                    fill: geometryTempShape.fill,
                    lineWidth: geometryTempShape.lineWidth
                });
                geometryTempShape = null;
                redrawGeometryCanvas();
                showNotification('å¤šè¾¹å½¢ç»˜åˆ¶å®Œæˆ', 'success');
            }
        }

        function handleGeometryRightClick(e) {
            e.preventDefault();
            // å³é”®å–æ¶ˆå½“å‰ç»˜åˆ¶
            if (geometryTempShape) {
                geometryTempShape = null;
                redrawGeometryCanvas();
                showNotification('å·²å–æ¶ˆç»˜åˆ¶', 'info');
            }
        }

        function addGeometryShape(shape) {
            geometryHistory.push([...geometryShapes]);
            geometryShapes.push(shape);
            redrawGeometryCanvas();
        }

        function redrawGeometryCanvas() {
            if (!geometryCtx) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            geometryCtx.clearRect(0, 0, geometryCanvas.width, geometryCanvas.height);
            
            // ç»˜åˆ¶æ‰€æœ‰å›¾å½¢
            geometryShapes.forEach((shape, index) => {
                const isSelected = (index === geometrySelectedShape);
                drawGeometryShape(shape, false, isSelected);
            });
            
            // ç»˜åˆ¶ä¸´æ—¶å›¾å½¢
            if (geometryTempShape) {
                drawGeometryShape(geometryTempShape, true, false);
            }
            
            // ç»˜åˆ¶å¤šè¾¹å½¢ä¸´æ—¶ç‚¹
            if (geometryTempShape && geometryTempShape.type === 'polygon') {
                geometryTempShape.points.forEach((point, index) => {
                    drawGeometryPoint(point.x, point.y, '#0071e3', index === 0 ? 6 : 4);
                });
            }
        }

        function drawGeometryShape(shape, isTemp = false, isSelected = false) {
            geometryCtx.strokeStyle = shape.color;
            geometryCtx.lineWidth = shape.lineWidth;
            geometryCtx.fillStyle = shape.fill || 'transparent';
            
            if (isTemp) {
                geometryCtx.setLineDash([5, 5]);
            } else {
                geometryCtx.setLineDash([]);
            }
            
            switch (shape.type) {
                case 'point':
                    drawGeometryPoint(shape.x, shape.y, shape.color, shape.lineWidth + 4);
                    if (isSelected) {
                        drawGeometryPoint(shape.x, shape.y, '#0071e3', shape.lineWidth + 8, true);
                    }
                    break;
                case 'line':
                case 'segment':
                    geometryCtx.beginPath();
                    geometryCtx.moveTo(shape.x1, shape.y1);
                    geometryCtx.lineTo(shape.x2, shape.y2);
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x1, shape.y1);
                        drawSelectionIndicator(shape.x2, shape.y2);
                    }
                    break;
                case 'circle':
                    geometryCtx.beginPath();
                    geometryCtx.arc(shape.x, shape.y, shape.radius, 0, Math.PI * 2);
                    if (shape.fill && shape.fill !== 'transparent') {
                        geometryCtx.fill();
                    }
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x, shape.y);
                        drawSelectionIndicator(shape.x + shape.radius, shape.y);
                    }
                    break;
                case 'rectangle':
                    geometryCtx.beginPath();
                    geometryCtx.rect(shape.x, shape.y, shape.width, shape.height);
                    if (shape.fill && shape.fill !== 'transparent') {
                        geometryCtx.fill();
                    }
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x, shape.y);
                        drawSelectionIndicator(shape.x + shape.width, shape.y);
                        drawSelectionIndicator(shape.x, shape.y + shape.height);
                        drawSelectionIndicator(shape.x + shape.width, shape.y + shape.height);
                    }
                    break;
                case 'triangle':
                    geometryCtx.beginPath();
                    geometryCtx.moveTo(shape.x1, shape.y1);
                    geometryCtx.lineTo(shape.x2, shape.y2);
                    geometryCtx.lineTo(shape.x3, shape.y3);
                    geometryCtx.closePath();
                    if (shape.fill && shape.fill !== 'transparent') {
                        geometryCtx.fill();
                    }
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x1, shape.y1);
                        drawSelectionIndicator(shape.x2, shape.y2);
                        drawSelectionIndicator(shape.x3, shape.y3);
                    }
                    break;
                case 'polygon':
                    if (shape.points.length > 1) {
                        geometryCtx.beginPath();
                        geometryCtx.moveTo(shape.points[0].x, shape.points[0].y);
                        for (let i = 1; i < shape.points.length; i++) {
                            geometryCtx.lineTo(shape.points[i].x, shape.points[i].y);
                        }
                        if (shape.fill && shape.fill !== 'transparent') {
                            geometryCtx.fill();
                        }
                        geometryCtx.stroke();
                        if (isSelected) {
                            shape.points.forEach(p => drawSelectionIndicator(p.x, p.y));
                        }
                    }
                    break;
            }
            
            geometryCtx.setLineDash([]);
        }

        // ç»˜åˆ¶é€‰ä¸­æŒ‡ç¤ºå™¨ï¼ˆå°æ–¹å—ï¼‰
        function drawSelectionIndicator(x, y) {
            const size = 6;
            geometryCtx.fillStyle = '#0071e3';
            geometryCtx.fillRect(x - size/2, y - size/2, size, size);
            geometryCtx.strokeStyle = '#ffffff';
            geometryCtx.lineWidth = 1;
            geometryCtx.strokeRect(x - size/2, y - size/2, size, size);
        }

        function drawGeometryPoint(x, y, color, size) {
            geometryCtx.beginPath();
            geometryCtx.arc(x, y, size / 2, 0, Math.PI * 2);
            geometryCtx.fillStyle = color;
            geometryCtx.fill();
        }

        function clearGeometryCanvas() {
            if (geometryShapes.length === 0) return;
            if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿæ‰€æœ‰å›¾å½¢å°†è¢«åˆ é™¤ã€‚')) {
                geometryHistory.push([...geometryShapes]);
                geometryShapes = [];
                geometryTempShape = null;
                redrawGeometryCanvas();
                showNotification('ç”»å¸ƒå·²æ¸…ç©º', 'success');
            }
        }

        function undoGeometry() {
            if (geometryHistory.length === 0) {
                showNotification('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'warning');
                return;
            }
            geometryShapes = geometryHistory.pop();
            geometryTempShape = null;
            redrawGeometryCanvas();
            showNotification('å·²æ’¤é”€', 'success');
        }

        function toggleGeometryGrid() {
            geometryShowGrid = !geometryShowGrid;
            geometryCanvas.classList.toggle('grid-hidden', !geometryShowGrid);
            document.querySelector('#geometry-grid-toggle i').classList.toggle('text-gray-600', geometryShowGrid);
            document.querySelector('#geometry-grid-toggle i').classList.toggle('text-primary', !geometryShowGrid);
        }

        function exportGeometryImage() {
            if (geometryShapes.length === 0) {
                showNotification('ç”»å¸ƒä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'warning');
                return;
            }
            
            // åˆ›å»ºä¸´æ—¶ç”»å¸ƒï¼Œä¸åŒ…å«ç½‘æ ¼
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = geometryCanvas.width;
            tempCanvas.height = geometryCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // ç»˜åˆ¶æ‰€æœ‰å›¾å½¢
            geometryShapes.forEach(shape => {
                tempCtx.strokeStyle = shape.color;
                tempCtx.lineWidth = shape.lineWidth;
                tempCtx.fillStyle = shape.fill || 'transparent';
                
                switch (shape.type) {
                    case 'point':
                        tempCtx.beginPath();
                        tempCtx.arc(shape.x, shape.y, (shape.lineWidth + 4) / 2, 0, Math.PI * 2);
                        tempCtx.fillStyle = shape.color;
                        tempCtx.fill();
                        break;
                    case 'line':
                    case 'segment':
                        tempCtx.beginPath();
                        tempCtx.moveTo(shape.x1, shape.y1);
                        tempCtx.lineTo(shape.x2, shape.y2);
                        tempCtx.stroke();
                        break;
                    case 'circle':
                        tempCtx.beginPath();
                        tempCtx.arc(shape.x, shape.y, shape.radius, 0, Math.PI * 2);
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                    case 'rectangle':
                        tempCtx.beginPath();
                        tempCtx.rect(shape.x, shape.y, shape.width, shape.height);
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                    case 'triangle':
                        tempCtx.beginPath();
                        tempCtx.moveTo(shape.x1, shape.y1);
                        tempCtx.lineTo(shape.x2, shape.y2);
                        tempCtx.lineTo(shape.x3, shape.y3);
                        tempCtx.closePath();
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                    case 'polygon':
                        if (shape.points.length > 1) {
                            tempCtx.beginPath();
                            tempCtx.moveTo(shape.points[0].x, shape.points[0].y);
                            for (let i = 1; i < shape.points.length; i++) {
                                tempCtx.lineTo(shape.points[i].x, shape.points[i].y);
                            }
                            if (shape.fill && shape.fill !== 'transparent') {
                                tempCtx.fill();
                            }
                            tempCtx.stroke();
                        }
                        break;
                }
            });
            
            // ä¸‹è½½å›¾ç‰‡
            const link = document.createElement('a');
            link.download = `å‡ ä½•å›¾å½¢_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
            
            showNotification('å›¾ç‰‡å·²å¯¼å‡º', 'success');
        }

        // ========== æ”¶å…¥è®°å½•ç¨‹åº ==========
        let incomeCurrentDate = new Date();
        let incomeData = {};
        let incomeDefaultRate = 200;
        let incomeEditingDate = null;
        const INCOME_STORAGE_KEY = 'teacherIncomeData';
        const INCOME_SETTINGS_KEY = 'teacherIncomeSettings';

        function initIncomeModule() {
            loadIncomeData();
            loadIncomeSettings();
            renderIncomeCalendar();
            updateIncomeStats();
            
            // ç»‘å®šè¾“å…¥æ¡†å®æ—¶è®¡ç®—
            const hoursInput = document.getElementById('income-hours');
            const rateInput = document.getElementById('income-rate');
            const bonusInput = document.getElementById('income-bonus');
            
            [hoursInput, rateInput, bonusInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', calculateIncomePreview);
                }
            });
        }

        function loadIncomeData() {
            const saved = localStorage.getItem(INCOME_STORAGE_KEY);
            if (saved) {
                incomeData = JSON.parse(saved);
            }
        }

        function saveIncomeData() {
            localStorage.setItem(INCOME_STORAGE_KEY, JSON.stringify(incomeData));
        }

        function loadIncomeSettings() {
            const saved = localStorage.getItem(INCOME_SETTINGS_KEY);
            if (saved) {
                const settings = JSON.parse(saved);
                incomeDefaultRate = settings.defaultRate || 200;
            }
        }

        function saveIncomeSettings() {
            const rate = document.getElementById('income-default-rate').value;
            if (rate) {
                incomeDefaultRate = parseFloat(rate);
                localStorage.setItem(INCOME_SETTINGS_KEY, JSON.stringify({
                    defaultRate: incomeDefaultRate
                }));
                closeIncomeSettings();
                showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
            }
        }

        function changeIncomeMonth(offset) {
            incomeCurrentDate.setMonth(incomeCurrentDate.getMonth() + offset);
            renderIncomeCalendar();
            updateIncomeStats();
        }

        function renderIncomeCalendar() {
            const year = incomeCurrentDate.getFullYear();
            const month = incomeCurrentDate.getMonth();
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('income-month-title').textContent = 
                `${year}å¹´${String(month + 1).padStart(2, '0')}æœˆ`;
            
            const grid = document.getElementById('income-calendar-grid');
            grid.innerHTML = '';
            
            // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // è·å–ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼Œ1=å‘¨ä¸€ï¼‰
            let startDayOfWeek = firstDay.getDay();
            if (startDayOfWeek === 0) startDayOfWeek = 7;
            startDayOfWeek--; // è°ƒæ•´ä¸ºå‘¨ä¸€ä¸º0
            
            // æ·»åŠ ä¸Šæœˆçš„æ—¥æœŸ
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const cell = createIncomeDayCell(day, true);
                grid.appendChild(cell);
            }
            
            // æ·»åŠ å½“æœˆçš„æ—¥æœŸ
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === year && 
                               today.getMonth() === month && 
                               today.getDate() === day;
                const data = incomeData[dateKey];
                
                const cell = createIncomeDayCell(day, false, isToday, data, dateKey);
                grid.appendChild(cell);
            }
            
            // æ·»åŠ ä¸‹æœˆçš„æ—¥æœŸ
            const remainingCells = 42 - (startDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createIncomeDayCell(day, true);
                grid.appendChild(cell);
            }
        }

        function createIncomeDayCell(day, isOtherMonth, isToday = false, data = null, dateKey = null) {
            const cell = document.createElement('div');
            cell.className = 'income-day-cell';
            
            if (isOtherMonth) {
                cell.classList.add('other-month');
            }
            if (isToday) {
                cell.classList.add('today');
            }
            if (data) {
                cell.classList.add('has-data');
            }
            
            // åˆ¤æ–­æ˜¯å¦æ˜¯å‘¨æœ«
            const date = dateKey ? new Date(dateKey) : null;
            if (date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    cell.classList.add('weekend');
                }
            }
            
            let html = `<div class="income-day-number">${day}</div>`;
            
            if (data) {
                if (data.hours > 0) {
                    html += `<div class="income-day-hours">${data.hours}h</div>`;
                }
                const totalAmount = (data.hours * data.rate) + (data.bonus || 0);
                html += `<div class="income-day-amount">${totalAmount}å…ƒ</div>`;
            } else if (!isOtherMonth && dateKey) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¼‘æ¯æ—¥ï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰
                const dayOfWeek = new Date(dateKey).getDay();
                if (dayOfWeek === 0) {
                    html += `<div class="income-day-rest">ä¼‘æ¯</div>`;
                }
            }
            
            cell.innerHTML = html;
            
            if (dateKey) {
                cell.onclick = () => openIncomeModal(dateKey);
            }
            
            return cell;
        }

        function updateIncomeStats() {
            const year = incomeCurrentDate.getFullYear();
            const month = incomeCurrentDate.getMonth();
            
            let totalHours = 0;
            let totalAmount = 0;
            let totalBonus = 0;
            
            Object.keys(incomeData).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    const data = incomeData[dateKey];
                    totalHours += data.hours || 0;
                    totalAmount += (data.hours || 0) * (data.rate || 0);
                    totalBonus += data.bonus || 0;
                }
            });
            
            const grandTotal = totalAmount + totalBonus;
            
            document.getElementById('income-total-hours').textContent = totalHours.toFixed(1) + 'h';
            document.getElementById('income-total-amount').textContent = totalAmount.toFixed(1) + 'å…ƒ';
            document.getElementById('income-total-bonus').textContent = totalBonus.toFixed(1) + 'å…ƒ';
            document.getElementById('income-grand-total').textContent = grandTotal.toFixed(1) + 'å…ƒ';
        }

        function openIncomeModal(dateKey) {
            incomeEditingDate = dateKey;
            const data = incomeData[dateKey];
            
            document.getElementById('income-modal-title').textContent = 
                data ? 'ç¼–è¾‘æ”¶å…¥è®°å½•' : 'è®°å½•æ”¶å…¥';
            document.getElementById('income-date').value = dateKey;
            document.getElementById('income-hours').value = data ? data.hours : '';
            document.getElementById('income-rate').value = data ? data.rate : incomeDefaultRate;
            document.getElementById('income-bonus').value = data ? (data.bonus || '') : '';
            document.getElementById('income-note').value = data ? (data.note || '') : '';
            document.getElementById('income-btn-delete').style.display = data ? 'block' : 'none';
            
            calculateIncomePreview();
            document.getElementById('income-modal').classList.add('show');
        }

        function closeIncomeModal() {
            document.getElementById('income-modal').classList.remove('show');
            incomeEditingDate = null;
        }

        function calculateIncomePreview() {
            const hours = parseFloat(document.getElementById('income-hours').value) || 0;
            const rate = parseFloat(document.getElementById('income-rate').value) || 0;
            const bonus = parseFloat(document.getElementById('income-bonus').value) || 0;
            
            const amount = hours * rate;
            const total = amount + bonus;
            
            document.getElementById('income-calc-amount').textContent = amount.toFixed(1) + 'å…ƒ';
            document.getElementById('income-calc-total').textContent = total.toFixed(1) + 'å…ƒ';
        }

        function saveIncomeRecord() {
            if (!incomeEditingDate) return;
            
            const hours = parseFloat(document.getElementById('income-hours').value) || 0;
            const rate = parseFloat(document.getElementById('income-rate').value) || 0;
            const bonus = parseFloat(document.getElementById('income-bonus').value) || 0;
            const note = document.getElementById('income-note').value.trim();
            
            if (hours === 0 && bonus === 0) {
                showNotification('è¯·è¾“å…¥å·¥ä½œæ—¶é•¿æˆ–è¡¥è´´é‡‘é¢', 'warning');
                return;
            }
            
            incomeData[incomeEditingDate] = {
                hours,
                rate,
                bonus,
                note,
                updatedAt: new Date().toISOString()
            };
            
            saveIncomeData();
            renderIncomeCalendar();
            updateIncomeStats();
            closeIncomeModal();
            showNotification('æ”¶å…¥è®°å½•å·²ä¿å­˜', 'success');
        }

        function deleteIncomeRecord() {
            if (!incomeEditingDate) return;
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ”¶å…¥è®°å½•å—ï¼Ÿ')) {
                delete incomeData[incomeEditingDate];
                saveIncomeData();
                renderIncomeCalendar();
                updateIncomeStats();
                closeIncomeModal();
                showNotification('æ”¶å…¥è®°å½•å·²åˆ é™¤', 'success');
            }
        }

        function showIncomeSettings() {
            document.getElementById('income-default-rate').value = incomeDefaultRate;
            document.getElementById('income-settings-modal').classList.add('show');
        }

        function closeIncomeSettings() {
            document.getElementById('income-settings-modal').classList.remove('show');
        }

        function exportIncomeToExcel() {
            const year = incomeCurrentDate.getFullYear();
            const month = incomeCurrentDate.getMonth();
            
            const records = [];
            Object.keys(incomeData).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    const data = incomeData[dateKey];
                    records.push({
                        date: dateKey,
                        ...data
                    });
                }
            });
            
            if (records.length === 0) {
                showNotification('æœ¬æœˆæš‚æ— æ”¶å…¥è®°å½•å¯å¯¼å‡º', 'warning');
                return;
            }
            
            records.sort((a, b) => a.date.localeCompare(b.date));
            
            const data = [['æ—¥æœŸ', 'å·¥ä½œæ—¶é•¿(å°æ—¶)', 'è¯¾æ—¶è´¹å•ä»·(å…ƒ)', 'è¯¾æ—¶æ”¶å…¥(å…ƒ)', 'è¡¥è´´(å…ƒ)', 'æ€»æ”¶å…¥(å…ƒ)', 'å¤‡æ³¨']];
            
            records.forEach(record => {
                const amount = record.hours * record.rate;
                const total = amount + (record.bonus || 0);
                data.push([
                    record.date,
                    record.hours,
                    record.rate,
                    amount,
                    record.bonus || 0,
                    total,
                    record.note || ''
                ]);
            });
            
            // æ·»åŠ æ±‡æ€»è¡Œ
            const totalHours = records.reduce((sum, r) => sum + r.hours, 0);
            const totalAmount = records.reduce((sum, r) => sum + (r.hours * r.rate), 0);
            const totalBonus = records.reduce((sum, r) => sum + (r.bonus || 0), 0);
            const grandTotal = totalAmount + totalBonus;
            
            data.push(['', '', '', '', '', '', '']);
            data.push(['æ±‡æ€»', totalHours, '', totalAmount, totalBonus, grandTotal, '']);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                { wch: 12 }, { wch: 15 }, { wch: 15 }, 
                { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 30 }
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ”¶å…¥è®°å½•');
            XLSX.writeFile(wb, `æ”¶å…¥è®°å½•_${year}å¹´${String(month + 1).padStart(2, '0')}æœˆ.xlsx`);
            
            showNotification('æ”¶å…¥è®°å½•å·²å¯¼å‡ºExcel', 'success');
        }

        // ========== å‡½æ•°ç»˜åˆ¶ç¨‹åº ==========
        let functionChart = null;
        let chartScale = 1; // ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
        const baseRange = 10; // åŸºç¡€åæ ‡èŒƒå›´
        const { jsPDF } = window.jspdf;
        const coordTooltip = document.getElementById('coord-tooltip');
        const chartContainer = document.getElementById('chart-container');
        const functionTags = document.getElementById('function-tags');
        // é¢œè‰²æ± ï¼š12ç§é«˜åŒºåˆ†åº¦é¢œè‰²
        const colorPool = ['#165DFF', '#36CFC9', '#FF7D00', '#722ED1', '#F759AB', '#13C2C2', '#FF9F1C', '#2F54EB', '#F5222D', '#52C41A', '#FAAD14', '#7B61FF'];
        let colorIndex = 0; 
        let datasetId = 0; 

        function initFunctionDrawing() {
            initTabSwitch();
            initFunctionTypeSwitch();
            initEquationTypeSwitch();
            initChart();
            bindGraphEvents();
            bindEquationEvents();
            bindChartInteractions();
            initSliders();
        }

        // 1. æ¨¡å—é€‰é¡¹å¡åˆ‡æ¢
        function initTabSwitch() {
            const tabGraph = document.getElementById('tab-graph');
            const tabEquation = document.getElementById('tab-equation');
            const moduleGraph = document.getElementById('module-graph');
            const moduleEquation = document.getElementById('module-equation');

            tabGraph.addEventListener('click', function() {
                tabGraph.classList.add('tab-active');
                tabEquation.classList.remove('tab-active');
                moduleGraph.classList.remove('hidden');
                moduleGraph.classList.add('block');
                moduleEquation.classList.add('hidden');
                moduleEquation.classList.remove('block');
                
                // åˆ‡æ¢æ ‡ç­¾åé‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
                setTimeout(() => {
                    if (functionChart) {
                        functionChart.resize();
                        functionChart.update();
                    }
                }, 50);
            });

            tabEquation.addEventListener('click', function() {
                tabEquation.classList.add('tab-active');
                tabGraph.classList.remove('tab-active');
                moduleEquation.classList.remove('hidden');
                moduleEquation.classList.add('block');
                moduleGraph.classList.add('hidden');
                moduleGraph.classList.remove('block');
            });
        }

        // 2. å‡½æ•°ç±»å‹é€‰æ‹©åˆ‡æ¢
        function initFunctionTypeSwitch() {
            const functionType = document.getElementById('function-type');
            const coeffBoxes = [
                'direct', 'linear', 'quadratic', 'hyperbola', 'power',
                'exponential', 'logarithmic', 'sine', 'cosine', 'ellipse', 'conic-hyperbola'
            ];

            functionType.addEventListener('change', function() {
                const value = this.value;
                coeffBoxes.forEach(type => {
                    document.getElementById(`coeff-${type}`).classList.add('hidden');
                });
                document.getElementById(`coeff-${value}`).classList.remove('hidden');
            });
        }

        // 3. æ–¹ç¨‹ç±»å‹é€‰æ‹©åˆ‡æ¢
        function initEquationTypeSwitch() {
            // ä¸»é€‰é¡¹å¡ï¼ˆä¸€å…ƒ/äºŒå…ƒï¼‰
            const tabSingle = document.getElementById('tab-single');
            const tabSystem = document.getElementById('tab-system');
            const singleEquation = document.getElementById('single-equation');
            const systemEquation = document.getElementById('system-equation');

            tabSingle.addEventListener('click', function() {
                tabSingle.classList.add('tab-active');
                tabSystem.classList.remove('tab-active');
                singleEquation.classList.remove('hidden');
                singleEquation.classList.add('block');
                systemEquation.classList.add('hidden');
                systemEquation.classList.remove('block');
                resetSolutionResult();
            });

            tabSystem.addEventListener('click', function() {
                tabSystem.classList.add('tab-active');
                tabSingle.classList.remove('tab-active');
                systemEquation.classList.remove('hidden');
                systemEquation.classList.add('block');
                singleEquation.classList.add('hidden');
                singleEquation.classList.remove('block');
                resetSolutionResult();
            });

            // ä¸€å…ƒæ–¹ç¨‹å­ç±»å‹ï¼ˆä¸€æ¬¡/äºŒæ¬¡ï¼‰
            const singleType = document.getElementById('single-type');
            const singleOneCoeff = document.getElementById('single-one-coeff');
            const singleTwoCoeff = document.getElementById('single-two-coeff');

            singleType.addEventListener('change', function() {
                const value = this.value;
                singleOneCoeff.classList.add('hidden');
                singleTwoCoeff.classList.add('hidden');
                if (value === 'one') singleOneCoeff.classList.remove('hidden');
                else if (value === 'two') singleTwoCoeff.classList.remove('hidden');
                resetSolutionResult();
            });
        }

        // 4. åˆå§‹åŒ–å‡½æ•°ç»˜å›¾ç”»å¸ƒ - ä¸é™åˆ¶åæ ‡è½´èŒƒå›´
        function initChart() {
            const ctx = document.getElementById('function-chart').getContext('2d');
            functionChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'center',
                            grid: { 
                                color: '#E5E7EB',
                                lineWidth: 1
                            },
                            ticks: { 
                                stepSize: 1, 
                                precision: 1,
                                font: {
                                    size: 11
                                }
                            },
                            min: -baseRange * chartScale,
                            max: baseRange * chartScale,
                            animation: false
                        },
                        y: {
                            type: 'linear',
                            position: 'center',
                            grid: { 
                                color: '#E5E7EB',
                                lineWidth: 1
                            },
                            ticks: { 
                                stepSize: 1, 
                                precision: 1,
                                font: {
                                    size: 11
                                }
                            },
                            min: -baseRange * chartScale,
                            max: baseRange * chartScale,
                            animation: false
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: { duration: 300 },
                    interaction: { mode: 'nearest', intersect: false },
                    elements: {
                        line: {
                            spanGaps: false,
                            tension: 0.1
                        },
                        point: {
                            radius: 0,
                            hoverRadius: 4
                        }
                    },
                    layout: {
                        padding: {
                            top: 5,
                            right: 5,
                            bottom: 5,
                            left: 5
                        }
                    }
                }
            });
        }

        // 5. ç»‘å®šç”»å¸ƒäº¤äº’ï¼šæ»‘è½®ç¼©æ”¾ + é¼ æ ‡å®æ—¶åæ ‡
        function bindChartInteractions() {
            // æ»‘è½®ç¼©æ”¾
            chartContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.1 : -0.1;
                chartScale = Math.max(0.2, Math.min(5, chartScale + delta));
                
                // æ›´æ–°åæ ‡è½´èŒƒå›´
                functionChart.options.scales.x.min = -baseRange * chartScale;
                functionChart.options.scales.x.max = baseRange * chartScale;
                functionChart.options.scales.y.min = -baseRange * chartScale;
                functionChart.options.scales.y.max = baseRange * chartScale;
                functionChart.update('none');
            });

            // é¼ æ ‡å®æ—¶åæ ‡
            chartContainer.addEventListener('mousemove', function(e) {
                if (!functionChart) return;
                
                const rect = functionChart.canvas.getBoundingClientRect();
                const x = functionChart.scales.x.getValueForPixel(e.clientX - rect.left);
                const y = functionChart.scales.y.getValueForPixel(e.clientY - rect.top);
                
                // æ£€æŸ¥åæ ‡æ˜¯å¦åœ¨å›¾è¡¨èŒƒå›´å†…
                if (x >= functionChart.scales.x.min && x <= functionChart.scales.x.max &&
                    y >= functionChart.scales.y.min && y <= functionChart.scales.y.max) {
                    const xFormatted = x.toFixed(2);
                    const yFormatted = y.toFixed(2);
                    coordTooltip.textContent = `(x, y) = (${xFormatted}, ${yFormatted})`;
                    coordTooltip.style.left = `${e.clientX + 10}px`;
                    coordTooltip.style.top = `${e.clientY + 10}px`;
                    coordTooltip.classList.remove('hidden');
                } else {
                    coordTooltip.classList.add('hidden');
                }
            });

            chartContainer.addEventListener('mouseleave', function() {
                coordTooltip.classList.add('hidden');
            });
        }

        // 6. ç”Ÿæˆå‡½æ•°æ•°æ®ç‚¹
        function generateFunctionData(type) {
            const data = [];
            
            // è·å–ç”¨æˆ·è®¾ç½®çš„å›¾åƒç»˜åˆ¶èŒƒå›´
            let xStart = parseFloat(document.getElementById('x-start').value) || -10;
            let xEnd = parseFloat(document.getElementById('x-end').value) || 10;
            
            // ç¡®ä¿èµ·å§‹å€¼å°äºç»“æŸå€¼
            if (xStart > xEnd) {
                [xStart, xEnd] = [xEnd, xStart];
            }
            
            // è®¡ç®—æ­¥é•¿
            const range = xEnd - xStart;
            const step = Math.max(0.01, range / 500);
            
            switch (type) {
                case 'direct':
                    const kDirect = parseFloat(document.getElementById('k-direct').value) || 1;
                    for (let x = xStart; x <= xEnd; x += step) {
                        data.push({ x, y: kDirect * x });
                    }
                    break;
                
                case 'linear':
                    const k = parseFloat(document.getElementById('k').value) || 1;
                    const b = parseFloat(document.getElementById('b').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        data.push({ x, y: k * x + b });
                    }
                    break;
                
                case 'quadratic':
                    const a = parseFloat(document.getElementById('a').value) || 1;
                    const bq = parseFloat(document.getElementById('bq').value) || 0;
                    const c = parseFloat(document.getElementById('c').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = a * x * x + bq * x + c;
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'hyperbola':
                    const kh = parseFloat(document.getElementById('kh').value) || 1;
                    
                    if (xStart < 0 && xEnd > 0) {
                        // å·¦ä¾§åˆ†æ”¯
                        for (let x = xStart; x <= -0.1; x += step) {
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                        // æ·»åŠ nullå€¼æ–­å¼€è¿æ¥
                        data.push({ x: null, y: null });
                        // å³ä¾§åˆ†æ”¯
                        for (let x = 0.1; x <= xEnd; x += step) {
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                    } else if (xEnd <= 0) {
                        // åªåœ¨è´ŸåŠè½´
                        for (let x = xStart; x <= xEnd; x += step) {
                            if (x === 0) continue;
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                    } else {
                        // åªåœ¨æ­£åŠè½´
                        for (let x = xStart; x <= xEnd; x += step) {
                            if (x === 0) continue;
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                    }
                    break;
                
                case 'power':
                    const n = parseFloat(document.getElementById('n').value) || 2;
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæ•´æ•°
                    const isInteger = Math.abs(Math.round(n) - n) < 0.0001;
                    
                    if (isInteger) {
                        const intN = Math.round(n);
                        
                        if (intN > 0) {
                            // æ­£æ•´æ•°æ¬¡å¹‚
                            for (let x = xStart; x <= xEnd; x += step) {
                                const y = Math.pow(x, intN);
                                data.push({ x, y: y });
                            }
                        } else {
                            // è´Ÿæ•´æ•°æ¬¡å¹‚
                            for (let x = xStart; x <= xEnd; x += step) {
                                if (x === 0) continue;
                                const y = Math.pow(x, intN);
                                data.push({ x, y: y });
                            }
                        }
                    } else {
                        // éæ•´æ•°æ¬¡å¹‚
                        const denominator = Math.abs(Math.round(1 / (n - Math.floor(n)))) || 1;
                        
                        if (denominator % 2 === 0) {
                            // åˆ†æ¯ä¸ºå¶æ•°æ—¶ï¼Œåº•æ•°å¿…é¡»éè´Ÿ
                            for (let x = Math.max(0, xStart); x <= xEnd; x += step) {
                                const y = Math.pow(x, n);
                                data.push({ x, y: y });
                            }
                        } else {
                            // åˆ†æ¯ä¸ºå¥‡æ•°æ—¶ï¼Œåº•æ•°å¯ä»¥ä¸ºä»»æ„å®æ•°
                            for (let x = xStart; x <= xEnd; x += step) {
                                if (x === 0 && n < 0) continue;
                                const y = Math.pow(x, n);
                                data.push({ x, y: y });
                            }
                        }
                    }
                    break;
                
                case 'exponential':
                    const aExp = parseFloat(document.getElementById('a-exp').value) || 2;
                    const validA = aExp > 0 && aExp !== 1 ? aExp : 2;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = Math.pow(validA, x);
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'logarithmic':
                    const aLog = parseFloat(document.getElementById('a-log').value) || 10;
                    const validALog = aLog > 0 && aLog !== 1 ? aLog : 10;
                    const logStart = Math.max(0.0001, xStart);
                    const smallStep = Math.min(step, 0.001);
                    
                    let x = logStart;
                    while (x <= xEnd) {
                        const y = Math.log(x) / Math.log(validALog);
                        if (Math.abs(y) < 1000) {
                            data.push({ x, y: y });
                        }
                        x += x < 0.1 ? smallStep : step;
                    }
                    break;
                
                case 'sine':
                    const ASin = parseFloat(document.getElementById('A-sin').value) || 1;
                    const wSin = parseFloat(document.getElementById('w-sin').value) || 1;
                    const phiSin = parseFloat(document.getElementById('phi-sin').value) || 0;
                    const dSin = parseFloat(document.getElementById('d-sin').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = ASin * Math.sin(wSin * x + phiSin) + dSin;
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'cosine':
                    const ACos = parseFloat(document.getElementById('A-cos').value) || 1;
                    const wCos = parseFloat(document.getElementById('w-cos').value) || 1;
                    const phiCos = parseFloat(document.getElementById('phi-cos').value) || 0;
                    const dCos = parseFloat(document.getElementById('d-cos').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = ACos * Math.cos(wCos * x + phiCos) + dCos;
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'ellipse':
                    const aEllipse = parseFloat(document.getElementById('a-ellipse').value) || 3;
                    const bEllipse = parseFloat(document.getElementById('b-ellipse').value) || 2;
                    // ä½¿ç”¨å‚æ•°æ–¹ç¨‹ç”Ÿæˆæ¤­åœ†æ•°æ®ç‚¹
                    const angleStep = 0.01;
                    for (let t = 0; t < 2 * Math.PI; t += angleStep) {
                        const x = aEllipse * Math.cos(t);
                        const y = bEllipse * Math.sin(t);
                        data.push({ x, y });
                    }
                    // é—­åˆæ¤­åœ†
                    data.push(data[0]);
                    break;
                
                case 'conic-hyperbola':
                    const aHyperbola = parseFloat(document.getElementById('a-hyperbola').value) || 2;
                    const bHyperbola = parseFloat(document.getElementById('b-hyperbola').value) || 1;
                    // ä½¿ç”¨å‚æ•°æ–¹ç¨‹ç”ŸæˆåŒæ›²çº¿æ•°æ®ç‚¹
                    const hyperbolaStep = 0.01;
                    // å³æ”¯
                    for (let t = -Math.PI/2 + 0.01; t < Math.PI/2 - 0.01; t += hyperbolaStep) {
                        const x = aHyperbola / Math.cos(t);
                        const y = bHyperbola * Math.tan(t);
                        data.push({ x, y });
                    }
                    // æ·»åŠ æ–­ç‚¹
                    data.push({ x: null, y: null });
                    // å·¦æ”¯
                    for (let t = Math.PI/2 + 0.01; t < 3*Math.PI/2 - 0.01; t += hyperbolaStep) {
                        const x = aHyperbola / Math.cos(t);
                        const y = bHyperbola * Math.tan(t);
                        data.push({ x, y });
                    }
                    break;
            }
            return data;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–ä¸‹ä¸€ä¸ªä¸é‡å¤çš„é¢œè‰²
        function getNextColor() {
            const color = colorPool[colorIndex];
            colorIndex = (colorIndex + 1) % colorPool.length;
            return color;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–å‡½æ•°åç§°
        function getFunctionName(type) {
            const nameMap = {
                direct: 'æ­£æ¯”ä¾‹å‡½æ•°', linear: 'ä¸€æ¬¡å‡½æ•°', quadratic: 'äºŒæ¬¡å‡½æ•°',
                hyperbola: 'åæ¯”ä¾‹å‡½æ•°', power: 'å¹‚å‡½æ•°', exponential: 'æŒ‡æ•°å‡½æ•°',
                logarithmic: 'å¯¹æ•°å‡½æ•°', sine: 'æ­£å¼¦å‡½æ•°', cosine: 'ä½™å¼¦å‡½æ•°',
                ellipse: 'æ¤­åœ†', 'conic-hyperbola': 'åœ†é”¥æ›²çº¿åŒæ›²çº¿'
            };
            return nameMap[type] || 'å‡½æ•°';
        }

        // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºå‡½æ•°æ ‡ç­¾
        function createFunctionTag(id, type, color) {
            const name = getFunctionName(type);
            const tag = document.createElement('div');
            tag.className = 'func-tag';
            tag.dataset.id = id;
            tag.innerHTML = `
                <span class="w-2 h-2 rounded-full" style="background-color: ${color};"></span>
                <span class="text-sm">${name}</span>
                <i class="fa fa-times func-delete ml-1" title="åˆ é™¤è¯¥å‡½æ•°"></i>
            `;
            
            // æ¸…ç©ºé»˜è®¤æç¤º
            if (functionTags.innerHTML.includes('æš‚æ— å‡½æ•°')) {
                functionTags.innerHTML = '';
            }
            
            functionTags.appendChild(tag);

            // ç»‘å®šåˆ é™¤äº‹ä»¶
            tag.querySelector('.func-delete').addEventListener('click', function() {
                functionChart.data.datasets = functionChart.data.datasets.filter(ds => ds.id !== id);
                functionChart.update();
                tag.remove();
                
                // å¦‚æœæ²¡æœ‰å‡½æ•°äº†ï¼Œæ˜¾ç¤ºæç¤º
                if (functionTags.children.length === 0) {
                    functionTags.innerHTML = '<span class="text-xs text-gray-500">æš‚æ— å‡½æ•°</span>';
                }
            });
        }

        // éªŒè¯å‡½æ•°ç³»æ•°æ˜¯å¦åˆæ³•
        function validateFunctionCoefficients(type) {
            switch(type) {
                case 'direct':
                    const kDirect = parseFloat(document.getElementById('k-direct').value);
                    if (kDirect === 0) {
                        alert('é”™è¯¯ï¼šæ­£æ¯”ä¾‹å‡½æ•°çš„æ¯”ä¾‹ç³»æ•°kä¸èƒ½ä¸º0ï¼');
                        return false;
                    }
                    break;
                case 'linear':
                    const kLinear = parseFloat(document.getElementById('k').value);
                    if (kLinear === 0) {
                        alert('é”™è¯¯ï¼šä¸€æ¬¡å‡½æ•°çš„æ–œç‡kä¸èƒ½ä¸º0ï¼');
                        return false;
                    }
                    break;
                case 'quadratic':
                    const aQuadratic = parseFloat(document.getElementById('a').value);
                    if (aQuadratic === 0) {
                        alert('é”™è¯¯ï¼šäºŒæ¬¡å‡½æ•°çš„äºŒæ¬¡é¡¹ç³»æ•°aä¸èƒ½ä¸º0ï¼');
                        return false;
                    }
                    break;
                case 'hyperbola':
                    const kHyperbola = parseFloat(document.getElementById('kh').value);
                    if (kHyperbola === 0) {
                        alert('é”™è¯¯ï¼šåæ¯”ä¾‹å‡½æ•°çš„æ¯”ä¾‹ç³»æ•°kä¸èƒ½ä¸º0ï¼');
                        return false;
                    }
                    break;
                case 'exponential':
                    const aExponential = parseFloat(document.getElementById('a-exp').value);
                    if (aExponential <= 0 || aExponential === 1) {
                        alert('é”™è¯¯ï¼šæŒ‡æ•°å‡½æ•°çš„åº•æ•°aå¿…é¡»æ»¡è¶³a>0ä¸”aâ‰ 1ï¼');
                        return false;
                    }
                    break;
                case 'logarithmic':
                    const aLogarithmic = parseFloat(document.getElementById('a-log').value);
                    if (aLogarithmic <= 0 || aLogarithmic === 1) {
                        alert('é”™è¯¯ï¼šå¯¹æ•°å‡½æ•°çš„åº•æ•°aå¿…é¡»æ»¡è¶³a>0ä¸”aâ‰ 1ï¼');
                        return false;
                    }
                    break;
                case 'ellipse':
                    const aEllipse = parseFloat(document.getElementById('a-ellipse').value);
                    const bEllipse = parseFloat(document.getElementById('b-ellipse').value);
                    if (aEllipse <= 0 || bEllipse <= 0) {
                        alert('é”™è¯¯ï¼šæ¤­åœ†çš„é•¿åŠè½´aå’ŒçŸ­åŠè½´bå¿…é¡»å¤§äº0ï¼');
                        return false;
                    }
                    break;
                case 'conic-hyperbola':
                    const aHyperbola = parseFloat(document.getElementById('a-hyperbola').value);
                    const bHyperbola = parseFloat(document.getElementById('b-hyperbola').value);
                    if (aHyperbola <= 0 || bHyperbola <= 0) {
                        alert('é”™è¯¯ï¼šåŒæ›²çº¿çš„å®åŠè½´aå’Œè™šåŠè½´bå¿…é¡»å¤§äº0ï¼');
                        return false;
                    }
                    break;
            }
            return true;
        }

        // ç»‘å®šå›¾åƒç»˜åˆ¶ç›¸å…³äº‹ä»¶
        function bindGraphEvents() {
            // ç»˜åˆ¶å›¾åƒæŒ‰é’®
            document.getElementById('draw-graph').addEventListener('click', function() {
                const functionType = document.getElementById('function-type').value;
                
                // éªŒè¯ç³»æ•°
                if (!validateFunctionCoefficients(functionType)) {
                    return;
                }
                
                // ç”Ÿæˆå‡½æ•°æ•°æ®
                const data = generateFunctionData(functionType);
                
                // åˆ›å»ºæ–°çš„æ•°æ®é›†
                const color = getNextColor();
                const newDataset = {
                    id: datasetId++,
                    label: getFunctionName(functionType),
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: false
                };
                
                // æ·»åŠ åˆ°å›¾è¡¨
                functionChart.data.datasets.push(newDataset);
                functionChart.update();
                
                // åˆ›å»ºå‡½æ•°æ ‡ç­¾
                createFunctionTag(newDataset.id, functionType, color);
            });
            
            // æ¸…ç©ºæ‰€æœ‰å›¾åƒæŒ‰é’®
            document.getElementById('reset-graph').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å‡½æ•°å›¾åƒå—ï¼Ÿ')) {
                    functionChart.data.datasets = [];
                    functionChart.update();
                    functionTags.innerHTML = '<span class="text-xs text-gray-500">æš‚æ— å‡½æ•°</span>';
                    colorIndex = 0;
                    datasetId = 0;
                }
            });
            
            // å¯¼å‡ºPDFæŒ‰é’®
            document.getElementById('export-pdf').addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                
                html2canvas(document.getElementById('chart-container')).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 280;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    doc.save('å‡½æ•°å›¾åƒ_' + new Date().toISOString().slice(0,10) + '.pdf');
                });
            });
        }

        // ç»‘å®šæ–¹ç¨‹æ±‚è§£ç›¸å…³äº‹ä»¶
        function bindEquationEvents() {
            document.getElementById('solve-equation').addEventListener('click', function() {
                const singleType = document.getElementById('single-type').value;
                const tabSingle = document.getElementById('tab-single');
                
                if (tabSingle.classList.contains('tab-active')) {
                    if (singleType === 'one') {
                        solveLinearEquation();
                    } else if (singleType === 'two') {
                        solveQuadraticEquation();
                    }
                } else {
                    solveSystemEquation();
                }
            });
        }

        // è§£ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹
        function solveLinearEquation() {
            const a = parseFloat(document.getElementById('sa1').value);
            const b = parseFloat(document.getElementById('sb1').value);
            
            if (a === 0) {
                alert('é”™è¯¯ï¼šä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹çš„ç³»æ•°aä¸èƒ½ä¸º0ï¼');
                return;
            }
            
            const x = -b / a;
            const solution = `x = ${x}`;
            
            displaySolution(`
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium mb-2">ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹æ±‚è§£</h3>
                    <p class="mb-2">æ–¹ç¨‹ï¼š${a}x + ${b} = 0</p>
                    <p class="mb-2">ç§»é¡¹å¾—ï¼š${a}x = ${-b}</p>
                    <p class="mb-2">è§£å¾—ï¼šx = ${-b} Ã· ${a} = ${x}</p>
                    <p class="font-medium mt-2">è§£ï¼š${solution}</p>
                </div>
            `);
        }

        // è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹
        function solveQuadraticEquation() {
            const a = parseFloat(document.getElementById('sa2').value);
            const b = parseFloat(document.getElementById('sb2').value);
            const c = parseFloat(document.getElementById('sc2').value);
            
            if (a === 0) {
                alert('é”™è¯¯ï¼šä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹çš„äºŒæ¬¡é¡¹ç³»æ•°aä¸èƒ½ä¸º0ï¼');
                return;
            }
            
            const delta = b * b - 4 * a * c;
            let solution = '';
            
            if (delta < 0) {
                solution = 'æ— å®æ•°è§£';
            } else if (delta === 0) {
                const x = -b / (2 * a);
                solution = `xâ‚ = xâ‚‚ = ${x}`;
            } else {
                const x1 = (-b + Math.sqrt(delta)) / (2 * a);
                const x2 = (-b - Math.sqrt(delta)) / (2 * a);
                solution = `xâ‚ = ${x1.toFixed(4)}, xâ‚‚ = ${x2.toFixed(4)}`;
            }
            
            displaySolution(`
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium mb-2">ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹æ±‚è§£</h3>
                    <p class="mb-2">æ–¹ç¨‹ï¼š${a}xÂ² + ${b}x + ${c} = 0</p>
                    <p class="mb-2">åˆ¤åˆ«å¼ï¼šÎ” = bÂ² - 4ac = ${b}Â² - 4Ã—${a}Ã—${c} = ${delta}</p>
                    ${delta < 0 ? '<p class="mb-2">å› ä¸ºÎ” < 0ï¼Œæ‰€ä»¥æ–¹ç¨‹æ— å®æ•°è§£</p>' : 
                      delta === 0 ? `<p class="mb-2">å› ä¸ºÎ” = 0ï¼Œæ‰€ä»¥æ–¹ç¨‹æœ‰ä¸€ä¸ªå®æ•°è§£</p><p class="mb-2">x = -b/(2a) = ${-b}/(2Ã—${a}) = ${(-b/(2*a)).toFixed(4)}</p>` : 
                      `<p class="mb-2">å› ä¸ºÎ” > 0ï¼Œæ‰€ä»¥æ–¹ç¨‹æœ‰ä¸¤ä¸ªå®æ•°è§£</p><p class="mb-2">xâ‚ = (-b + âˆšÎ”)/(2a) = (${-b} + âˆš${delta})/(2Ã—${a}) = ${((-b + Math.sqrt(delta))/(2*a)).toFixed(4)}</p><p class="mb-2">xâ‚‚ = (-b - âˆšÎ”)/(2a) = (${-b} - âˆš${delta})/(2Ã—${a}) = ${((-b - Math.sqrt(delta))/(2*a)).toFixed(4)}</p>`}
                    <p class="font-medium mt-2">è§£ï¼š${solution}</p>
                </div>
            `);
        }

        // è§£äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹ç»„
        function solveSystemEquation() {
            const a1 = parseFloat(document.getElementById('a1').value);
            const b1 = parseFloat(document.getElementById('b1').value);
            const c1 = parseFloat(document.getElementById('c1').value);
            const a2 = parseFloat(document.getElementById('a2').value);
            const b2 = parseFloat(document.getElementById('b2').value);
            const c2 = parseFloat(document.getElementById('c2').value);
            
            const D = a1 * b2 - a2 * b1;
            const Dx = c1 * b2 - c2 * b1;
            const Dy = a1 * c2 - a2 * c1;
            
            let solution = '';
            
            if (D === 0) {
                if (Dx === 0 && Dy === 0) {
                    solution = 'æ–¹ç¨‹ç»„æœ‰æ— æ•°è§£';
                } else {
                    solution = 'æ–¹ç¨‹ç»„æ— è§£';
                }
            } else {
                const x = Dx / D;
                const y = Dy / D;
                solution = `x = ${x.toFixed(4)}, y = ${y.toFixed(4)}`;
            }
            
            displaySolution(`
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium mb-2">äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹ç»„æ±‚è§£</h3>
                    <p class="mb-2">æ–¹ç¨‹ç»„ï¼š</p>
                    <p class="mb-2">â‘  ${a1}x + ${b1}y = ${c1}</p>
                    <p class="mb-2">â‘¡ ${a2}x + ${b2}y = ${c2}</p>
                    <p class="mb-2">ç³»æ•°è¡Œåˆ—å¼ï¼šD = ${a1}Ã—${b2} - ${a2}Ã—${b1} = ${D}</p>
                    <p class="mb-2">Dx = ${c1}Ã—${b2} - ${c2}Ã—${b1} = ${Dx}</p>
                    <p class="mb-2">Dy = ${a1}Ã—${c2} - ${a2}Ã—${c1} = ${Dy}</p>
                    ${D !== 0 ? `<p class="mb-2">å› ä¸ºD â‰  0ï¼Œæ‰€ä»¥æ–¹ç¨‹ç»„æœ‰å”¯ä¸€è§£</p><p class="mb-2">x = Dx/D = ${Dx}/${D} = ${(Dx/D).toFixed(4)}</p><p class="mb-2">y = Dy/D = ${Dy}/${D} = ${(Dy/D).toFixed(4)}</p>` : 
                      Dx === 0 && Dy === 0 ? '<p class="mb-2">å› ä¸ºD = 0ä¸”Dx = Dy = 0ï¼Œæ‰€ä»¥æ–¹ç¨‹ç»„æœ‰æ— æ•°è§£</p>' : 
                      '<p class="mb-2">å› ä¸ºD = 0ä½†Dxæˆ–Dy â‰  0ï¼Œæ‰€ä»¥æ–¹ç¨‹ç»„æ— è§£</p>'}
                    <p class="font-medium mt-2">è§£ï¼š${solution}</p>
                </div>
            `);
        }

        // æ˜¾ç¤ºæ–¹ç¨‹æ±‚è§£ç»“æœ
        function displaySolution(html) {
            document.getElementById('solution-result').innerHTML = html;
        }

        // é‡ç½®æ–¹ç¨‹æ±‚è§£ç»“æœ
        function resetSolutionResult() {
            document.getElementById('solution-result').innerHTML = `
                <div class="text-center text-gray-500 py-8 md:py-10">
                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                    <p>è¯·é€‰æ‹©æ–¹ç¨‹ç±»å‹å¹¶è¾“å…¥ç³»æ•°ï¼Œç‚¹å‡»æ±‚è§£æŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                    <p class="text-xs mt-2 text-gray-400">è§£é¢˜æ­¥éª¤ä¸¥æ ¼éµå¾ªä¸­å­¦æ•°å­¦ä¹¦å†™è§„èŒƒ</p>
                </div>
            `;
        }

        // åˆå§‹åŒ–æ»‘å—
        function initSliders() {
            // ç»˜åˆ¶èŒƒå›´æ»‘å—
            const xStart = document.getElementById('x-start');
            const xStartSlider = document.getElementById('x-start-slider');
            xStart.addEventListener('input', function() {
                xStartSlider.value = this.value;
            });
            xStartSlider.addEventListener('input', function() {
                xStart.value = this.value;
            });
            
            const xEnd = document.getElementById('x-end');
            const xEndSlider = document.getElementById('x-end-slider');
            xEnd.addEventListener('input', function() {
                xEndSlider.value = this.value;
            });
            xEndSlider.addEventListener('input', function() {
                xEnd.value = this.value;
            });
            
            // å…¶ä»–æ»‘å—...
        }

        // åˆå§‹åŒ–å‡½æ•°ç»˜åˆ¶åŠŸèƒ½
        window.addEventListener('load', function() {
            initFunctionDrawing();
        });
    </script>
</body>
</html>